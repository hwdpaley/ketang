{
    "version": 3,
    "sources": [
        "../../../src/ext/model/ext_ad_space.js"
    ],
    "names": [
        "upad",
        "spaceid",
        "json",
        "replace",
        "adtemp",
        "info",
        "setting",
        "find",
        "where",
        "space",
        "model",
        "name",
        "type",
        "temp",
        "match",
        "think",
        "isEmpty",
        "num",
        "option",
        "status",
        "order",
        "JSON",
        "parse",
        "width",
        "height",
        "val",
        "param",
        "split",
        "url",
        "push",
        "call_user_func",
        "str_replace",
        "select",
        "loop",
        "loopmatch",
        "looparr",
        "jsonarr",
        "v",
        "console",
        "log",
        "reparr",
        "loopstr",
        "join",
        "count",
        "items",
        "update",
        "code",
        "cache",
        "showad",
        "timeout",
        "list",
        "_",
        "filter",
        "Number",
        "base"
    ],
    "mappings": "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",
    "file": "../../../src/ext/model/ext_ad_space.js",
    "sourcesContent": [
        "// +----------------------------------------------------------------------\n// | Bieber [ 美媒网站内容管理框架 ]\n// +----------------------------------------------------------------------\n// | Copyright (c) 2017 http://www.gzxinbibo.com All rights reserved.\n// +----------------------------------------------------------------------\n// | Author: Tony <912697590@qq.com>\n// +----------------------------------------------------------------------\n\n'use strict';\n/**\n * model\n */\nexport default class extends think.model.base {\n    /**\n     * 更新广告\n     *\n     * @param spaceid 广告位id\n     * @returns {Promise.<void>}\n     */\n\n   async upad(spaceid){\n       //获取广告模板\n        let json,replace=[],adtemp='',info,setting;\n       let space = await this.find({where:{spaceid:spaceid}});\n       let temp = await this.model('ext_ad_temp').find({where:{name:space.type}});\n        //console.log(temp);\n        let match = temp.temp.match(/\\[(\\S+?)\\]/g);\n        if(!think.isEmpty(match)){\n        if(temp.num==1&&temp.option==0){\n         info = await this.model(\"ext_ad\").where({spaceid:space.spaceid,status:1}).order(\"sort ASC,addtime DESC\").find();\n         if(!think.isEmpty(info.setting)){\n            setting = JSON.parse(info.setting);\n            setting[0].width=space.width;\n            setting[0].height=space.height;\n            json=JSON.stringify(setting[0]);\n               for(let val of match){\n                   val= val.replace(/(^\\[)|(\\]$)/g, \"\");\n                   let param = val.split('|');\n                   //console.log(param);\n                   if(param[0]===\"url\"){\n                       if(think.isEmpty(setting[0].url)){\n                           replace.push(\"javascript:void(0)\")\n                       }else {\n                           replace.push(setting[0][param[0]])\n                       }\n                   }else if(!think.isEmpty(param[1])){\n                       replace.push(await call_user_func(param[1],setting[0][param[0]]));\n                   }else {\n                       replace.push(setting[0][param[0]])\n                   }\n               }\n             adtemp = str_replace(match,replace,temp.temp);\n         }else {\n\n         }\n           }else if(temp.num==1&&temp.option==1){\n            info = await this.model(\"ext_ad\").where({spaceid:space.spaceid,status:1}).order(\"sort ASC,addtime DESC\").select();\n            let loop = temp.temp.match(/\\{loop\\}([\\S\\s]*?){\\/loop\\}/);\n            //let loop = temp.temp.split(\"{loop}\");\n            let loopmatch = loop[1].match(/\\[(\\S+?)\\]/g);\n            let looparr = [];\n            let jsonarr=[]\n            for(let v of info){\n                if(!think.isEmpty(v.setting)){\n                    setting = JSON.parse(v.setting);\n                    setting[0].width=space.width;\n                    setting[0].height=space.height;\n                    console.log(setting);\n                    jsonarr.push(setting[0])\n                    json=JSON.stringify(jsonarr);\n                    let reparr=[];\n                    for(let val of loopmatch){\n                        val= val.replace(/(^\\[)|(\\]$)/g, \"\");\n                        let param = val.split('|');\n                       //console.log(param);\n                        if(param[0]==\"url\"){\n                            console.log(22222222222)\n                            if(think.isEmpty(setting[0].url)){\n                                reparr.push(\"javascript:void(0)\")\n                            }else {\n                                reparr.push(setting[0][param[0]])\n                            }\n                        }else if(!think.isEmpty(param[1])){\n                            reparr.push(await call_user_func(param[1],setting[0][param[0]]));\n                        }else {\n                            reparr.push(setting[0][param[0]])\n                        }\n                    }\n                    console.log(reparr);\n                    let loopstr = str_replace(loopmatch,reparr,loop[1]);\n                    looparr.push(loopstr);\n                }\n            }\n            // console.log(looparr.join(\"\"));\n            adtemp = temp.temp.replace(loop[0], looparr.join(\"\"));\n            // console.log(adtemp);\n        }\n\n\n        }\n        //更新本广告位的广告数量\n        let items = await this.model('ext_ad').where({spaceid:space.spaceid}).count();\n        await this.where({spaceid:space.spaceid}).update({code:adtemp,json:json,items:items});\n        //清除广告缓存\n        think.cache(\"all_ad\",null);\n       }\n\n       async showad(spaceid){\n               //let list =\"22\";\n               let list = await think.cache(\"all_ad\", () => {\n                   return this.select();\n               }, {timeout: 365 * 24 * 3600});\n           //console.log(list);\n           if(think.isEmpty(spaceid)){\n                   return list;\n               }else {\n                   return think._.filter(list,{spaceid:Number(spaceid)});\n               }\n\n       }\n\n\n}"
    ]
}
{
    "version": 3,
    "sources": [
        "../../../src/topic/controller/base_safe_save_213357.js"
    ],
    "names": [
        "init",
        "http",
        "__before",
        "model",
        "getset",
        "setup",
        "api",
        "wx_AppID",
        "wx_AppSecret",
        "jssdk",
        "islogin",
        "is_login",
        "assign",
        "wx_url",
        "is_weixin",
        "userAgent",
        "uurl",
        "url",
        "action",
        "weixin",
        "deferred",
        "think",
        "defer",
        "getSignPackage",
        "err",
        "signPackage",
        "isEmpty",
        "resolve",
        "console",
        "error",
        "promise",
        "log",
        "WEB_SITE_CLOSE",
        "session",
        "isshow",
        "Error",
        "statusAction",
        "user",
        "roleid",
        "uid",
        "where",
        "id",
        "getField",
        "extend",
        "get_model",
        "shopCart",
        "cartList",
        "cartInfo",
        "total",
        "num",
        "data",
        "val",
        "push",
        "price",
        "qty",
        "getstock",
        "product_id",
        "type",
        "stock",
        "eval",
        "join",
        "cart",
        "res",
        "weblogin",
        "checkMobile",
        "redirect",
        "category",
        "field",
        "info",
        "cate",
        "status",
        "display",
        "cartdata",
        "loadata",
        "select",
        "Number",
        "update",
        "add",
        "parseDocumentList",
        "list",
        "model_id",
        "get_model_attribute",
        "attrList",
        "isArray",
        "forEach",
        "k",
        "key",
        "extra",
        "options",
        "parse_config_attr",
        "oparr",
        "in_array",
        "dateformat",
        "setCorsHeader",
        "header",
        "controller",
        "base"
    ],
    "mappings": "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",
    "file": "../../../src/topic/controller/base_safe_save_213357.js",
    "sourcesContent": [
        "// +----------------------------------------------------------------------\n// | Bieber [ 美媒网站内容管理框架 ]\n// +----------------------------------------------------------------------\n// | Copyright (c) 2017 http://www.gzxinbibo.com All rights reserved.\n// +----------------------------------------------------------------------\n// | Author: Tony <912697590@qq.com>\n// +----------------------------------------------------------------------\n\n'use strict';\nimport API from 'wechat-api';\nimport JSSDK from '../../uc/controller/jssdk.js';\nexport default class extends think.controller.base {\n    init(http) {\n        super.init(http);\n        \n    }\n\n    async __before() {\n            this.setup = await this.model(\"setup\").getset();\n            this.api = new API(this.setup.wx_AppID, this.setup.wx_AppSecret);\n            this.jssdk = JSSDK;\n            //网站配置\n                        // console.log(this.setup);\n            //当前登录状态\n            this.is_login = await this.islogin();\n\n            // let userInfo = await this.model(\"member\").find(this.is_login);\n            // console.log(userInfo);\n            //判断公众账号类型?\n            // if (is_weixin(this.userAgent())) {\n            //     await this.oauthAction();\n            //     let aa = function(jssdk, url) {\n            //         let deferred = think.defer();\n            //         jssdk.getSignPackage(url, (err, signPackage) => {\n            //             if (!think.isEmpty(signPackage)) {\n            //                 deferred.resolve(signPackage);\n            //             } else {\n            //                 console.error(err);\n            //             }\n            //         });\n            //         return deferred.promise;\n            //     }\n            //     let signPackage = await aa(this.jssdk, uurl);\n            //     console.log(signPackage);\n            //     this.assign(\"signPackage\", signPackage);\n            // }\n            this.assign(\"wxhttp\", this.setup.wx_url);\n            if (is_weixin(this.userAgent())) {\n                let uurl = this.setup.wx_url + this.http.url;\n                    await this.action(\"uc/weixin\", \"oauth\");\n                    let weixin = function(jssdk, url) {\n                        let deferred = think.defer();\n                        jssdk.getSignPackage(url, (err, signPackage) => {\n                            if (!think.isEmpty(signPackage)) {\n                                deferred.resolve(signPackage);\n                            } else {\n                                console.error(err);\n                            }\n                        });\n                        return deferred.promise;\n                    }\n                    let signPackage = await weixin(this.jssdk, uurl);\n                    console.log(signPackage);\n                    this.assign(\"signPackage\", signPackage);\n            }\n            // if (checkMobile(this.userAgent())) {\n            //     if (is_weixin(this.userAgent())) {\n            //         let uurl = this.setup.wx_url + this.http.url;\n            //         await this.action(\"uc/weixin\", \"oauth\");\n            //         let weixin = function(jssdk, url) {\n            //             let deferred = think.defer();\n            //             jssdk.getSignPackage(url, (err, signPackage) => {\n            //                 if (!think.isEmpty(signPackage)) {\n            //                     deferred.resolve(signPackage);\n            //                 } else {\n            //                     console.error(err);\n            //                 }\n            //             });\n            //             return deferred.promise;\n            //         }\n            //         let signPackage = await weixin(this.jssdk, uurl);\n            //         console.log(signPackage);\n            //         this.assign(\"signPackage\", signPackage);\n            //     }else{\n            //         return think.statusAction(700, this.http);\n            //     }\n            // }\n            // let userinfo=await this.session('userInfo');\n            // console.log(\"__before----------,\"+JSON.stringify(userinfo) );\n            //关闭站点\n            if (this.setup.WEB_SITE_CLOSE == 0) {\n                let isshow = await this.session('userInfo');\n                if (think.isEmpty(isshow)) {\n                    this.http.error = new Error('该网站已关闭，只有管理员可以正常访问');\n                    return think.statusAction(404, this.http);\n                }\n            }\n            // let csrf = await this.session('__CSRF__');\n            //  // console.log(\"__CSRF__-------------,\" + csrf);\n            // await this.cookie('__CSRF__', csrf);\n            // this.assign('csrf', csrf);\n            //用户信息\n            this.user = {};\n            this.user.roleid = 8; //游客\n            this.user.uid=0;\n            //访问控制\n            if (this.is_login) {\n                this.user.roleid = await this.model(\"member\").where({ id: this.is_login }).getField('groupid', true);\n            }\n            this.user = think.extend(this.user, await this.session('webuser'));\n            // console.log(\"__before----------,\" + JSON.stringify(this.user));\n            this.assign(\"userInfo\", this.user);\n            //获取当前分类信息\n            //console.log(action);\n            // this.meta_title = cate.meta_title?cate.meta_title:cate.title;\n            //设置主题\n            //this.http.theme(\"default);\n            //购物车\n            //关闭商品模型时同时关闭购物车\n            if (!think.isEmpty(await this.model('model').get_model(4)) && this.http.action != \"avatar\") {\n                let cartList = await this.shopCart();\n                let cartInfo;\n                if (think.isEmpty(cartList)) {\n                    cartInfo = {\n                        total: 0,\n                        num: 0,\n                        data: null\n                    }\n\n                } else {\n\n                    let total = [];\n                    let num = [];\n                    for (let val of cartList) {\n                        total.push(val.price);\n                        num.push(val.qty);\n                        //判断是否有库存\n                        let stock = await this.model(\"order\").getstock(val.product_id, val.type);\n\n                        if (val.qty > stock) {\n                            val.stock = 0;\n                        } else {\n                            val.stock = stock;\n                        }\n                    }\n                    cartInfo = {\n                        total: eval(total.join('+')),\n                        num: eval(num.join('+')),\n                        data: cartList\n                    }\n                }\n                this.cart = cartInfo;\n            }\n        }\n        /**\n         * 判断是否登录\n         * @returns {boolean}\n         */\n    async islogin() {\n        //前台判断是否登录\n        let user = await this.session('webuser');\n        let res = think.isEmpty(user) ? false : user.uid;\n        return res;\n\n    }\n    async weblogin() {\n        let islogin = await this.islogin();\n        console.log('weblogin--------');\n        if (!islogin) {\n            //判断浏览客户端\n            if (checkMobile(this.userAgent())) {\n                //手机端直接跳转到登录页面\n                return this.redirect('/uc/public/login');\n            } else {\n                //pc端跳转到错误页面\n                return this.redirect('/uc/public/login');\n                // return think.statusAction(700, this.http);\n            }\n\n        }\n    }\n\n    //获取分类信息\n    async category(id, field) {\n            id = id || 0;\n            field = field || \"\";\n            if (think.isEmpty(id)) {\n                //this.fail('没有指定数据分类！');\n                this.http.error = new Error('没有指定数据分类！');\n                return think.statusAction(702, this.http);\n            }\n            console.log(\"category-----------\" + id + \",\" + field);\n            let cate = await this.model(\"category\").info(id, field);\n            //console.log(cate);\n            if (cate && 1 == cate.status) {\n\n                switch (cate.display) {\n                    case 0:\n                        //this.fail('该分类禁止显示')\n                        this.http.error = new Error('该分类禁止显示！');\n                        return think.statusAction(702, this.http);\n                        break;\n                        //TODO:更多分类显示状态判断\n                    default:\n\n                        return cate;\n                }\n\n            } else {\n\n                //this.fail(\"分类不存在或者被禁用！\");\n                this.http.error = new Error('分类不存在或者被禁用！');\n                return think.statusAction(702, this.http);\n            }\n        }\n        //购物车\n    async shopCart() {\n        let cartdata = null;\n        if (this.is_login) {\n            let loadata = await this.session(\"cart_goods_item\");\n            if (think.isEmpty(loadata)) {\n                cartdata = await this.model('cart').where({ uid: this.user.uid }).select();\n            } else {\n                //loadata = JSON.parse(loadata);\n                for (let val of loadata) {\n                    val.uid = this.user.uid;\n                    //验证原有的数据是否已经存在\n                    let res = await this.model('cart').where({ product_id: val.product_id, type: val.type, uid: this.user.uid }).select();\n                    //console.log(res);\n                    if (!think.isEmpty(res)) {\n                        val.qty = Number(val.qty) + Number(res[0].qty);\n                        val.id = res[0].id;\n                        await this.model('cart').update(val);\n                    } else {\n                        await this.model('cart').add(val);\n                    }\n\n                }\n                await this.session(\"cart_goods_item\", null);\n                cartdata = await this.model('cart').where({ uid: this.user.uid }).select();\n            }\n        } else {\n            cartdata = await this.session(\"cart_goods_item\");\n            // if(cartdata){\n            // cartdata = JSON.parse(cartdata);\n            // }\n        }\n        //console.log(cartdata);\n        return cartdata;\n    }\n\n    /**\n     * 处理文档列表显示\n     * @param {array} list 列表数据\n     * @param {integer} model_id 模型id\n     */\n    async parseDocumentList(list, model_id) {\n            model_id = model_id || 1;\n            let attrList = await this.model('attribute').get_model_attribute(model_id, false, 'id,name,type,extra');\n            //attrList=attrList[model_id];\n            //this.end(attrList);\n            // console.log(attrList);\n            if (think.isArray(list)) {\n                list.forEach((data, k) => {\n                        //console.log(data);\n                        for (let key in data) {\n                            //console.log(key)\n                            if (!think.isEmpty(attrList[key])) {\n                                let extra = attrList[key]['extra'];\n                                let type = attrList[key]['type'];\n                                //console.log(extra);\n                                if ('select' == type || 'checkbox' == type || 'radio' == type || 'bool' == type) {\n                                    // 枚举/多选/单选/布尔型\n                                    let options = parse_config_attr(extra);\n                                    let oparr = Object.keys(options);\n                                    if (options && in_array(data[key], oparr)) {\n                                        data[key] = options[data[key]];\n                                    }\n                                } else if ('date' == type) { // 日期型\n                                    data[key] = dateformat('Y-m-d', data[key]);\n                                } else if ('datetime' == type) { // 时间型\n                                    data[key] = dateformat('Y-m-d H:i', data[key]);\n                                } else if ('pics' === type) {\n                                    data[key] = `<span class=\"thumb-sm\"><img alt=\"...\" src=\"${data[key]}\" class=\"img-responsive img-thumbnail\"></span>`;\n                                }\n                            }\n                        }\n                        data.model_id = model_id;\n                        list[k] = data;\n                    })\n                    //console.log(222)\n                return list;\n            }\n        }\n        //跨域设置\n    setCorsHeader() {\n        this.header(\"Access-Control-Allow-Origin\", this.header(\"origin\") || \"*\");\n        this.header(\"Access-Control-Allow-Headers\", \"x-requested-with\");\n        this.header(\"Access-Control-Request-Method\", \"GET,POST,PUT,DELETE\");\n        this.header(\"Access-Control-Allow-Credentials\", \"true\");\n    }\n\n}\n"
    ]
}
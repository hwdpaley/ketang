{
    "version": 3,
    "sources": [
        "../../../src/topic/controller/detail.js"
    ],
    "names": [
        "indexAction",
        "id",
        "get",
        "console",
        "log",
        "document",
        "model",
        "detail",
        "info",
        "errno",
        "http",
        "error",
        "Error",
        "errmsg",
        "think",
        "statusAction",
        "roleid",
        "is_login",
        "where",
        "getField",
        "redirect",
        "priv",
        "category_id",
        "str",
        "content",
        "isEmpty",
        "img",
        "checkMobile",
        "userAgent",
        "image_view",
        "category",
        "cate",
        "extend",
        "meta_title",
        "title",
        "keywords",
        "keyname",
        "description",
        "split",
        "assign",
        "increment",
        "link_id",
        "get_parent_category",
        "breadcrumb",
        "order",
        "find",
        "previous",
        "next",
        "temp",
        "get_model",
        "model_id",
        "pid",
        "pinfo",
        "i",
        "nav",
        "topid",
        "lastinfo",
        "select",
        "plist",
        "field",
        "ptree_",
        "ptree",
        "get_children",
        "type",
        "template",
        "p_id",
        "get_table_name",
        "table",
        "p_info",
        "get_cover2",
        "cover_id",
        "setup",
        "QINIU_DOMAIN_NAME",
        "fmurl",
        "template_m_detail",
        "controller",
        "is_weixin",
        "display",
        "template_detail",
        "downloadgetidAction",
        "db",
        "file_id",
        "dlink",
        "location",
        "get_file",
        "d",
        "IS_QINIU",
        "qiniu",
        "service",
        "instance",
        "download",
        "savename",
        "savepath",
        "action",
        "pan",
        "panurl",
        "v",
        "varr",
        "_",
        "trim",
        "durl",
        "sn"
    ],
    "mappings": "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",
    "file": "../../../src/topic/controller/detail.js",
    "sourcesContent": [
        "// +----------------------------------------------------------------------\n// | Bieber [ 美媒网站内容管理框架 ]\n// +----------------------------------------------------------------------\n// | Copyright (c) 2017 http://www.gzxinbibo.com All rights reserved.\n// +----------------------------------------------------------------------\n// | Author: Tony <912697590@qq.com>\n// +----------------------------------------------------------------------\n\n'use strict';\n\nimport Base from './base.js';\n\nexport default class extends Base {\n  //详情页[核心]\n  async indexAction() {\n    /* 标识正确性检测*/\n    let id = this.get('id') || 0;\n    //if(!(id && think.isString(id))){\n    //    this.fail('文档ID错误！');\n    //} //if(!(id && think.isString(id))){\n    //    this.fail('文档ID错误！');\n    //}\n    console.log(\"id=\"+id);\n    /* 获取详细信息*/\n    let document = this.model('document');\n    let info = await document.detail(id);\n    if(info.errno==702){\n      this.http.error = new Error(info.errmsg);\n      return think.statusAction(702, this.http);\n    }\n    /* 页码检测*/\n    //TODO\n    let roleid=8;//游客\n    //访问控制\n    if(this.is_login){\n      roleid = await this.model(\"member\").where({id:this.is_login}).getField('groupid', true);\n    }\n    if(roleid==8){\n      \n        this.http.error = new Error('您尚未登录，请先登录！');\n        console.log('您尚未登录，请先登录！');\n        this.redirect(\"/uc/public/login\");\n      \n       // return think.statusAction(700, this.http);\n    }\n    let priv = await this.model(\"category_priv\").priv(info.category_id,roleid,'visit');\n    if(!priv){\n      this.http.error = new Error('您所在的用户组,禁止访问本栏目！');\n      return think.statusAction(700, this.http);\n      // return this.redirect('/uc/public/login');\n    }\n    //用户自己只可以看到自己发布的拓课信息，看不到其他用户的发布信息\n    // console.log(\"info-------------\"+JSON.stringify(info));\n    // console.log(\"user-------------\"+JSON.stringify(this.user));\n    // this.http.error = new Error('您所在的用户组,禁止访问本栏目！');\n    // return think.statusAction(702, this.http);\n\n    //不同的设备,压缩不同的图片尺寸\n    let str = info.content;\n    if(!think.isEmpty(str)){\n      let img;\n      if(checkMobile(this.userAgent())){\n        //手机端\n        img = image_view(str,640,4);\n      }else {\n        //pc端\n\n        img = image_view(str,847,0);\n      }\n      info.content=img;\n      // console.log(\"img----------\"+img);\n    }\n    \n    //分类信息\n    let cate = await this.category(info.category_id);\n    cate = think.extend({}, cate);\n    //seo\n    this.meta_title = info.title; //标题\n    this.keywords = info.keyname ? info.keyname : ''; //seo关键词\n    this.description = info.description ? info.description : \"\"; //seo描述\n    //keywords\n    let keywords;\n    if(!think.isEmpty(info.keyname)){\n      keywords = (info.keyname).split(\",\");\n    }\n    this.assign(\"keywords\",keywords);\n    //访问统计\n    await document.where({id:info.id}).increment('view');\n    //外链\n    if(!think.isEmpty(info.link_id)&&info.link_id!=0){\n      return this.redirect(info.link_id);\n    }\n    //获取面包屑信息\n    let breadcrumb = await this.model('category').get_parent_category(cate.id,true);\n    this.assign('breadcrumb', breadcrumb);\n    console.log(\"breadcrumb===========\"+JSON.stringify(breadcrumb));\n    // 上一篇\n    let previous = await document.where({id:['>',info.id],category_id:info.category_id,'pid':0, 'status': 1}).order('id DESC').find();\n    this.assign('previous',previous)\n    // 下一篇\n    let next = await document.where({id:['<',info.id],category_id:info.category_id,'pid':0, 'status': 1}).order('id DESC').find();\n    this.assign('next',next)\n\n    //获取模板\n    let temp;\n    let model = await this.model('model').get_model(info.model_id, 'name');\n    console.log(\"info.model_id-------------------\"+info.model_id);\n    //详情模版 TODO\n    //手机版模版\n\n    this.assign('category', cate);\n    //console.log(info);\n    //目录/文章/段落\n    let pid;\n    let pinfo;\n    if(info.pid !=0){\n      let i = info.id;\n      //\n      while (i!=0)\n      {\n        let nav = await document.where({id:i}).find();\n        if(nav.pid==0) {\n          pinfo = nav;\n          pid= nav.id;\n        }\n        i = nav.pid;\n\n      }\n\n    }else {\n      pinfo = info;\n      pid= info.id;\n    }\n    //获取最后更新时间\n    let lastinfo = await document.where({topid:pid}).order(\"update_time DESC\").find();\n    //console.log(lasttime);\n    this.assign(\"lastinfo\",lastinfo);\n    //console.log(pid);\n    let plist = await document.where({pid:pid}).order(\"level DESC\").select();\n    this.assign(\"pinfo\",pinfo);\n    this.assign(\"plist\",plist);\n    //console.log(plist);\n    if(plist[0]){\n      //let lastlevel = plist[0].level;\n      //console.log(lastlevel);\n      this.assign(\"lastlevel\",plist[0]);\n    }\n    //console.log(plist);\n    //文档无限级目录\n    let ptree_ = await document.where({topid:pid}).field('id,title,pid,name,level as sort').select();\n    let ptree = get_children(ptree_,pid,1);\n    //console.log(ptree);\n    this.assign('topid',pid);\n    this.assign(\"ptree\",ptree);\n\n    //如果是目录并且模板为空,模块为视频时，目录id，显示最后更新的主题\n    if(info.type == 1 && (think.isEmpty(info.template)||info.template==0)&&info.model_id==6){\n      if(plist[0]){\n        console.log(111111);\n        let model_id =  plist[0].model_id;\n        let p_id = plist[0].id;\n        let table = await this.model(\"model\").get_table_name(model_id);\n        let p_info = await this.model(table).find(p_id);\n        info = think.extend(info,p_info);\n\n      }\n    }\n    //console.log(info);\n    info.fmurl = await get_cover2(info.cover_id, this.setup.QINIU_DOMAIN_NAME);\n    this.assign('info', info);\n    this.assign(\"desc\", info.description);\n    //判断浏览客户端\n    if(checkMobile(this.userAgent())){\n      //手机模版\n      if (!think.isEmpty(info.template) && info.template !=0) {\n        temp = info.template; //todo 已设置详情模板\n      } else if (!think.isEmpty(cate.template_m_detail)) {\n        temp = cate.template_m_detail; //分类已经设置模板\n      } else {\n        temp = model;\n      }\n      \n      //内容分页\n      if(!think.isEmpty(info.content)){\n        info.content=info.content.split(\"_ueditor_page_break_tag_\");\n      }\n       console.log(\"mobile detail-index------------,\"+`mobile/${this.http.controller}/${temp}`);\n      if(is_weixin(this.userAgent())&&temp=='mytuoke.html'){\n        this.redirect(`/uc/weixin/tuoke/id/`+id);\n      }else{\n        return this.display(`mobile/${this.http.controller}/${temp}`);\n      }\n      \n      \n    }else{\n      if (!think.isEmpty(info.template) && info.template !=0) {\n        temp = info.template; //已设置详情模板\n      } else if (!think.isEmpty(cate.template_detail)) {\n        temp = cate.template_detail; //分类已经设置模板\n      } else {\n        temp = model;\n      }\n      // console.log(\"info----------------\"+JSON.stringify(info));\n      // console.log(\"cate----------------\"+JSON.stringify(cate));\n      console.log(\"temp-------------------\"+temp+\",\"+model);\n        //console.log(info);\n      //内容分页\n      if(!think.isEmpty(info.content)){\n        info.content=info.content.split(\"_ueditor_page_break_tag_\");\n      }\n      console.log(\"detail----------------\"+temp);\n      // console.log(\"detail info----------------\"+JSON.stringify(info));\n      return this.display(temp);\n    }\n  }\n\n  /**\n   * 下载\n   */\n  async downloadgetidAction(){\n    let id = this.get(\"id\").split(\"||\");\n      let db = this.model('document_download');\n      let info =await db.find(id[0]);\n      console.log(info);\n      let file_id = info.file_id;\n      console.log(file_id);\n      let dlink;\n      if(id[1]==1){\n          let location = await this.model('file').where({id:file_id}).getField(\"location\",true);\n          console.log(location);\n          let d = await get_file(file_id);\n          if(this.setup.IS_QINIU==1 && location==1){\n            //七牛下载\n             // dlink = await get_file(file_id,\"savename\",true);\n            let qiniu = think.service(\"qiniu\");\n            let instance = new qiniu();\n                dlink = await instance.download(d.savename);\n          }else {\n              // 本地下载\n              dlink = d.savepath+d.savename+\"?attname=\"\n          }\n          console.log(dlink);\n          //访问统计\n        await db.where({id:info.id}).increment('download');\n        //return this.redirect(dlink);\n        this.assign(\"durl\",dlink);\n        if(checkMobile(this.userAgent())){\n          //手机模版\n          return this.display(`mobile/${this.http.controller}/${this.http.action}`)\n        }else{\n          return this.display();\n        }\n      }else if(id[1]==2){\n          dlink = id[2];\n        await db.where({id:info.id}).increment('download');\n        return this.redirect(dlink);\n      }else if(id[1]==3){\n        //返回网盘提取码\n        let pan = info.panurl.split(\"\\r\\n\");\n        for(let v of pan){\n          let varr=v.split(\"|\");\n          console.log(varr[1]);\n          if(!think.isEmpty(varr[2]) && think._.trim(id[2])==think._.trim(varr[1])){\n            this.assign({\n              title:varr[0],\n              durl:varr[1],\n              sn:varr[2]\n            })\n          }\n        }\n          await db.where({id:info.id}).increment('download');\n        if(checkMobile(this.userAgent())){\n          //手机模版\n          return this.display(`mobile/${this.http.controller}/${this.http.action}`)\n        }else{\n          return this.display();\n        }\n      }\n\n  }\n}"
    ]
}
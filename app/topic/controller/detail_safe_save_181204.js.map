{
    "version": 3,
    "sources": [
        "../../../src/topic/controller/detail_safe_save_181204.js"
    ],
    "names": [
        "indexAction",
        "id",
        "get",
        "console",
        "log",
        "document",
        "model",
        "detail",
        "info",
        "errno",
        "http",
        "error",
        "Error",
        "errmsg",
        "think",
        "statusAction",
        "roleid",
        "is_login",
        "where",
        "getField",
        "is_weixin",
        "userAgent",
        "redirect",
        "action",
        "priv",
        "category_id",
        "str",
        "content",
        "isEmpty",
        "img",
        "checkMobile",
        "image_view",
        "category",
        "cate",
        "extend",
        "meta_title",
        "title",
        "keywords",
        "keyname",
        "description",
        "split",
        "assign",
        "increment",
        "link_id",
        "get_parent_category",
        "breadcrumb",
        "order",
        "find",
        "previous",
        "next",
        "temp",
        "get_model",
        "model_id",
        "pid",
        "pinfo",
        "i",
        "nav",
        "topid",
        "lastinfo",
        "select",
        "plist",
        "field",
        "ptree_",
        "ptree",
        "get_children",
        "type",
        "template",
        "p_id",
        "get_table_name",
        "table",
        "p_info",
        "get_cover2",
        "cover_id",
        "setup",
        "QINIU_DOMAIN_NAME",
        "fmurl",
        "template_m_detail",
        "controller",
        "display",
        "template_detail",
        "downloadgetidAction",
        "db",
        "file_id",
        "dlink",
        "location",
        "get_file",
        "d",
        "IS_QINIU",
        "qiniu",
        "service",
        "instance",
        "download",
        "savename",
        "savepath",
        "pan",
        "panurl",
        "v",
        "varr",
        "_",
        "trim",
        "durl",
        "sn"
    ],
    "mappings": "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",
    "file": "../../../src/topic/controller/detail_safe_save_181204.js",
    "sourcesContent": [
        "// +----------------------------------------------------------------------\n// | Bieber [ 美媒网站内容管理框架 ]\n// +----------------------------------------------------------------------\n// | Copyright (c) 2017 http://www.gzxinbibo.com All rights reserved.\n// +----------------------------------------------------------------------\n// | Author: Tony <912697590@qq.com>\n// +----------------------------------------------------------------------\n\n'use strict';\n\nimport Base from './base.js';\n\nexport default class extends Base {\n  //详情页[核心]\n  async indexAction() {\n    /* 标识正确性检测*/\n    let id = this.get('id') || 0;\n    //if(!(id && think.isString(id))){\n    //    this.fail('文档ID错误！');\n    //} //if(!(id && think.isString(id))){\n    //    this.fail('文档ID错误！');\n    //}\n    console.log(\"id=\"+id);\n    /* 获取详细信息*/\n    let document = this.model('document');\n    let info = await document.detail(id);\n    if(info.errno==702){\n      this.http.error = new Error(info.errmsg);\n      return think.statusAction(702, this.http);\n    }\n    /* 页码检测*/\n    //TODO\n    let roleid=8;//游客\n    //访问控制\n    if(this.is_login){\n      roleid = await this.model(\"member\").where({id:this.is_login}).getField('groupid', true);\n    }\n    if(roleid==8){\n      if(!is_weixin(this.userAgent())){\n\n      \n        this.http.error = new Error('您尚未登录，请先登录！');\n        console.log('您尚未登录，请先登录！');\n        this.redirect(\"/uc/public/login\");\n      }else{\n        await this.action(\"uc/weixin\",'oauth'); \n          // let openid = await this.session(\"wx_openid\");\n          // let member = await this.model(\"member\").where({ openid: openid }).find();\n          // let wx_userInfo = {\n          //     'uid': member.id,\n          //     'username': member.username,\n          //     'last_login_time': member.last_login_time,\n          // };\n          // await this.session('webuser', wx_userInfo);\n      }\n       // return think.statusAction(700, this.http);\n    }\n    let priv = await this.model(\"category_priv\").priv(info.category_id,roleid,'visit');\n    if(!priv){\n      this.http.error = new Error('您所在的用户组,禁止访问本栏目！');\n      return think.statusAction(700, this.http);\n      // return this.redirect('/uc/public/login');\n    }\n    //用户自己只可以看到自己发布的拓课信息，看不到其他用户的发布信息\n    // console.log(\"info-------------\"+JSON.stringify(info));\n    // console.log(\"user-------------\"+JSON.stringify(this.user));\n    // this.http.error = new Error('您所在的用户组,禁止访问本栏目！');\n    // return think.statusAction(702, this.http);\n\n    //不同的设备,压缩不同的图片尺寸\n    let str = info.content;\n    if(!think.isEmpty(str)){\n      let img;\n      if(checkMobile(this.userAgent())){\n        //手机端\n        img = image_view(str,640,4);\n      }else {\n        //pc端\n\n        img = image_view(str,847,0);\n      }\n      info.content=img;\n      // console.log(\"img----------\"+img);\n    }\n    \n    //分类信息\n    let cate = await this.category(info.category_id);\n    cate = think.extend({}, cate);\n    //seo\n    this.meta_title = info.title; //标题\n    this.keywords = info.keyname ? info.keyname : ''; //seo关键词\n    this.description = info.description ? info.description : \"\"; //seo描述\n    //keywords\n    let keywords;\n    if(!think.isEmpty(info.keyname)){\n      keywords = (info.keyname).split(\",\");\n    }\n    this.assign(\"keywords\",keywords);\n    //访问统计\n    await document.where({id:info.id}).increment('view');\n    //外链\n    if(!think.isEmpty(info.link_id)&&info.link_id!=0){\n      return this.redirect(info.link_id);\n    }\n    //获取面包屑信息\n    let breadcrumb = await this.model('category').get_parent_category(cate.id,true);\n    this.assign('breadcrumb', breadcrumb);\n    console.log(\"breadcrumb===========\"+JSON.stringify(breadcrumb));\n    // 上一篇\n    let previous = await document.where({id:['>',info.id],category_id:info.category_id,'pid':0, 'status': 1}).order('id DESC').find();\n    this.assign('previous',previous)\n    // 下一篇\n    let next = await document.where({id:['<',info.id],category_id:info.category_id,'pid':0, 'status': 1}).order('id DESC').find();\n    this.assign('next',next)\n\n    //获取模板\n    let temp;\n    let model = await this.model('model').get_model(info.model_id, 'name');\n    console.log(\"info.model_id-------------------\"+info.model_id);\n    //详情模版 TODO\n    //手机版模版\n\n    this.assign('category', cate);\n    //console.log(info);\n    //目录/文章/段落\n    let pid;\n    let pinfo;\n    if(info.pid !=0){\n      let i = info.id;\n      //\n      while (i!=0)\n      {\n        let nav = await document.where({id:i}).find();\n        if(nav.pid==0) {\n          pinfo = nav;\n          pid= nav.id;\n        }\n        i = nav.pid;\n\n      }\n\n    }else {\n      pinfo = info;\n      pid= info.id;\n    }\n    //获取最后更新时间\n    let lastinfo = await document.where({topid:pid}).order(\"update_time DESC\").find();\n    //console.log(lasttime);\n    this.assign(\"lastinfo\",lastinfo);\n    //console.log(pid);\n    let plist = await document.where({pid:pid}).order(\"level DESC\").select();\n    this.assign(\"pinfo\",pinfo);\n    this.assign(\"plist\",plist);\n    //console.log(plist);\n    if(plist[0]){\n      //let lastlevel = plist[0].level;\n      //console.log(lastlevel);\n      this.assign(\"lastlevel\",plist[0]);\n    }\n    //console.log(plist);\n    //文档无限级目录\n    let ptree_ = await document.where({topid:pid}).field('id,title,pid,name,level as sort').select();\n    let ptree = get_children(ptree_,pid,1);\n    //console.log(ptree);\n    this.assign('topid',pid);\n    this.assign(\"ptree\",ptree);\n\n    //如果是目录并且模板为空,模块为视频时，目录id，显示最后更新的主题\n    if(info.type == 1 && (think.isEmpty(info.template)||info.template==0)&&info.model_id==6){\n      if(plist[0]){\n        console.log(111111);\n        let model_id =  plist[0].model_id;\n        let p_id = plist[0].id;\n        let table = await this.model(\"model\").get_table_name(model_id);\n        let p_info = await this.model(table).find(p_id);\n        info = think.extend(info,p_info);\n\n      }\n    }\n    //console.log(info);\n    info.fmurl = await get_cover2(info.cover_id, this.setup.QINIU_DOMAIN_NAME);\n    this.assign('info', info);\n    this.assign(\"desc\", info.description);\n    //判断浏览客户端\n    if(checkMobile(this.userAgent())){\n      //手机模版\n      if (!think.isEmpty(info.template) && info.template !=0) {\n        temp = info.template; //todo 已设置详情模板\n      } else if (!think.isEmpty(cate.template_m_detail)) {\n        temp = cate.template_m_detail; //分类已经设置模板\n      } else {\n        temp = model;\n      }\n      \n      //内容分页\n      if(!think.isEmpty(info.content)){\n        info.content=info.content.split(\"_ueditor_page_break_tag_\");\n      }\n       console.log(\"mobile detail-index------------,\"+`mobile/${this.http.controller}/${temp}`);\n      if(is_weixin(this.userAgent())&&temp=='mytuoke.html'){\n        this.redirect(`/uc/weixin/tuoke/id/`+id);\n      }else{\n        return this.display(`mobile/${this.http.controller}/${temp}`);\n      }\n      \n      \n    }else{\n      if (!think.isEmpty(info.template) && info.template !=0) {\n        temp = info.template; //已设置详情模板\n      } else if (!think.isEmpty(cate.template_detail)) {\n        temp = cate.template_detail; //分类已经设置模板\n      } else {\n        temp = model;\n      }\n      // console.log(\"info----------------\"+JSON.stringify(info));\n      // console.log(\"cate----------------\"+JSON.stringify(cate));\n      console.log(\"temp-------------------\"+temp+\",\"+model);\n        //console.log(info);\n      //内容分页\n      if(!think.isEmpty(info.content)){\n        info.content=info.content.split(\"_ueditor_page_break_tag_\");\n      }\n      console.log(\"detail----------------\"+temp);\n      // console.log(\"detail info----------------\"+JSON.stringify(info));\n      return this.display(temp);\n    }\n  }\n\n  /**\n   * 下载\n   */\n  async downloadgetidAction(){\n    let id = this.get(\"id\").split(\"||\");\n      let db = this.model('document_download');\n      let info =await db.find(id[0]);\n      console.log(info);\n      let file_id = info.file_id;\n      console.log(file_id);\n      let dlink;\n      if(id[1]==1){\n          let location = await this.model('file').where({id:file_id}).getField(\"location\",true);\n          console.log(location);\n          let d = await get_file(file_id);\n          if(this.setup.IS_QINIU==1 && location==1){\n            //七牛下载\n             // dlink = await get_file(file_id,\"savename\",true);\n            let qiniu = think.service(\"qiniu\");\n            let instance = new qiniu();\n                dlink = await instance.download(d.savename);\n          }else {\n              // 本地下载\n              dlink = d.savepath+d.savename+\"?attname=\"\n          }\n          console.log(dlink);\n          //访问统计\n        await db.where({id:info.id}).increment('download');\n        //return this.redirect(dlink);\n        this.assign(\"durl\",dlink);\n        if(checkMobile(this.userAgent())){\n          //手机模版\n          return this.display(`mobile/${this.http.controller}/${this.http.action}`)\n        }else{\n          return this.display();\n        }\n      }else if(id[1]==2){\n          dlink = id[2];\n        await db.where({id:info.id}).increment('download');\n        return this.redirect(dlink);\n      }else if(id[1]==3){\n        //返回网盘提取码\n        let pan = info.panurl.split(\"\\r\\n\");\n        for(let v of pan){\n          let varr=v.split(\"|\");\n          console.log(varr[1]);\n          if(!think.isEmpty(varr[2]) && think._.trim(id[2])==think._.trim(varr[1])){\n            this.assign({\n              title:varr[0],\n              durl:varr[1],\n              sn:varr[2]\n            })\n          }\n        }\n          await db.where({id:info.id}).increment('download');\n        if(checkMobile(this.userAgent())){\n          //手机模版\n          return this.display(`mobile/${this.http.controller}/${this.http.action}`)\n        }else{\n          return this.display();\n        }\n      }\n\n  }\n}"
    ]
}
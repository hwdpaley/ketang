{
    "version": 3,
    "sources": [
        "../../../src/uc/controller/jssdk.js"
    ],
    "names": [
        "crypto",
        "require",
        "request",
        "fs",
        "debug",
        "JSSDK",
        "appId",
        "appSecret",
        "prototype",
        "setAppid",
        "getSignPackage",
        "url",
        "done",
        "instance",
        "console",
        "log",
        "getJsApiTicket",
        "err",
        "jsApiTicket",
        "nonceStr",
        "createNonceStr",
        "timestamp",
        "Math",
        "round",
        "Date",
        "now",
        "rawString",
        "hash",
        "createHash",
        "signature",
        "update",
        "digest",
        "cacheFile",
        "intance",
        "data",
        "readCacheFile",
        "time",
        "expireTime",
        "getAccessToken",
        "error",
        "accessToken",
        "get",
        "res",
        "body",
        "JSON",
        "parse",
        "writeCacheFile",
        "ticket",
        "e",
        "access_token",
        "chars",
        "length",
        "str",
        "i",
        "substr",
        "random",
        "filename",
        "readFileSync",
        "writeFileSync",
        "jssdk",
        "module",
        "exports"
    ],
    "mappings": "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",
    "file": "../../../src/uc/controller/jssdk.js",
    "sourcesContent": [
        "const crypto = require('crypto');\nconst request = require('request');\nconst fs = require('fs');\nconst debug = require('debug')('jswechat:jssdk');\n\nfunction JSSDK(appId, appSecret) {\n    this.appId = appId;\n    this.appSecret = appSecret;\n}\n\nJSSDK.prototype = {\n    setAppid:function(appId, appSecret){\n        this.appId = appId;\n        this.appSecret = appSecret;\n    },\n    getSignPackage: function (url, done) {\n        const instance = this;\n        console.log(\"jssdk----url-------------\"+url);\n        this.getJsApiTicket(function (err, jsApiTicket) {\n            if (err) {\n                return done(err);\n            }\n\n            const nonceStr = instance.createNonceStr();\n            const timestamp = Math.round(Date.now() / 1000);\n\n            // 生成签名\n            const rawString = `jsapi_ticket=${jsApiTicket}&noncestr=${nonceStr}&timestamp=${timestamp}&url=${url}`;\n            const hash = crypto.createHash('sha1');\n            const signature = hash.update(rawString).digest('hex');\n\n            done(null, {\n                timestamp,\n                url,\n                signature,\n                rawString,\n                nonceStr,\n                appId: instance.appId,\n            });\n        });\n    },\n\n    getJsApiTicket: function (done) {\n        const cacheFile = '.jsapiticket.json';\n        const intance = this;\n        const data = intance.readCacheFile(cacheFile);\n        const time = Math.round(Date.now() / 1000);\n\n        if (typeof data.expireTime === 'undefined' || data.expireTime < time) {\n            debug('getJsApiTicket: from server');\n            intance.getAccessToken(function (error, accessToken) {\n                if (error) {\n                    debug('getJsApiTicket.token.error:', error);\n                    return done(error, null);\n                }\n\n                const url = `https://api.weixin.qq.com/cgi-bin/ticket/getticket?type=jsapi&access_token=${accessToken}`;\n                request.get(url, function (err, res, body) {\n                    if (err) {\n                        debug('getJsApiTicket.request.error:', err, url);\n                        return done(err, null);\n                    }\n\n                    debug('getJsApiTicket.request.body:', body);\n\n                    try {\n                        const data = JSON.parse(body);\n\n                        intance.writeCacheFile(cacheFile, {\n                            expireTime: Math.round(Date.now() / 1000) + 7200,\n                            jsApiTicket: data.ticket,\n                        });\n\n                        done(null, data.ticket);\n                    } catch (e) {\n                        debug('getJsApiTicket.parse.error:', e, url);\n                        done(e, null);\n                    }\n                });\n            });\n        } else {\n            debug('getJsApiTicket: from cache');\n            done(null, data.jsApiTicket);\n        }\n    },\n\n    getAccessToken: function (done) {\n        const cacheFile = '.accesstoken.json';\n        const intance = this;\n        const data = intance.readCacheFile(cacheFile);\n        const time = Math.round(Date.now() / 1000);\n\n        if (typeof data.expireTime === 'undefined' || data.expireTime < time) {\n            debug('getAccessToken: from server');\n            const url = `https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=${this.appId}&secret=${this.appSecret}`;\n            request.get(url, function (err, res, body) {\n                if (err) {\n                    debug('getAccessToken.request.error:', err, url);\n                    return done(err, null);\n                }\n\n                debug('getAccessToken.request.body:', body);\n\n                try {\n                    const data = JSON.parse(body);\n\n                    intance.writeCacheFile(cacheFile, {\n                        expireTime: Math.round(Date.now() / 1000) + 7200,\n                        accessToken: data.access_token,\n                    });\n\n                    done(null, data.access_token);\n                } catch (e) {\n                    debug('getAccessToken.parse.error:', e, url);\n                    done(e, null);\n                }\n            });\n        } else {\n            debug('getAccessToken: from cache');\n            done(null, data.accessToken);\n        }\n    },\n\n    createNonceStr: function () {\n        const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';\n        const length = chars.length;\n        let str = '';\n        for (let i = 0; i < length; i++) {\n            str += chars.substr(Math.round(Math.random() * length), 1);\n        }\n        return str;\n    },\n\n    // 从文件里面读取缓存\n    readCacheFile: function (filename) {\n        try {\n            return JSON.parse(fs.readFileSync(filename));\n        } catch (e) {\n            debug('read file %s failed: %s', filename, e);\n        }\n\n        return {};\n    },\n\n    // 往文件里面写缓存\n    writeCacheFile: function (filename, data) {\n        return fs.writeFileSync(filename, JSON.stringify(data));\n    },\n};\n\nconst jssdk = new JSSDK('wx31783e0b591a7f4b', 'c4cca2d1622fd3e6f70aa78d2621db3b');\nmodule.exports = jssdk;\n\n// debug(jssdk.createNonceStr());\n// debug(jssdk.createNonceStr());\n//\n// jssdk.getAccessToken(function (err, accessToken) {\n//     console.log(arguments);\n// });\n//\n// jssdk.getJsApiTicket(function (err, accessToken) {\n//     console.log(arguments);\n// });\n//\n// jssdk.getSignPackage('http://120.27.106.168/wechat/hello', function (err, accessToken) {\n//     console.log(arguments);\n// });\n//"
    ]
}
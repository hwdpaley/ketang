{
    "version": 3,
    "sources": [
        "../../../src/uc/controller/weixin_safe_save_130919.js"
    ],
    "names": [
        "__before",
        "model",
        "getset",
        "setup",
        "api",
        "wx_AppID",
        "wx_AppSecret",
        "jssdk",
        "setAppid",
        "indexAction",
        "display",
        "oauthAction",
        "session",
        "openid",
        "console",
        "log",
        "is_weixin",
        "userAgent",
        "think",
        "isEmpty",
        "cookie",
        "http",
        "url",
        "oauthUrl",
        "wxPubOauth",
        "createOauthUrlForCode",
        "wx_url",
        "redirect",
        "where",
        "find",
        "wx_user",
        "uid",
        "getUser",
        "userinfo",
        "add",
        "getopenidAction",
        "code",
        "get",
        "getopenid",
        "deferred",
        "defer",
        "getOpenid",
        "err",
        "resolve",
        "promise",
        "subscribe_time",
        "Date",
        "getTime",
        "update",
        "filePath",
        "RESOURCE_PATH",
        "mkdir",
        "spiderImage",
        "headimgurl",
        "id",
        "getField",
        "last_login_time",
        "wx_userInfo",
        "nickname",
        "followAction",
        "qrcod",
        "showQRCodeURL",
        "wx_two",
        "assign",
        "meta_title",
        "checkMobile",
        "controller",
        "action",
        "signinAction",
        "open_id",
        "wx_info",
        "organizingAction",
        "data",
        "post",
        "res",
        "username",
        "fail",
        "ltrim",
        "mobile",
        "email",
        "password",
        "password2",
        "status",
        "reg_time",
        "valueOf",
        "reg_ip",
        "_ip2int",
        "ip",
        "encryptPassword",
        "reg",
        "autoLogin",
        "success",
        "name",
        "organizingphoneAction",
        "real_name",
        "groupid",
        "phone",
        "logonbindingAction",
        "signin",
        "imgUrl",
        "imgData",
        "setEncoding",
        "on",
        "chunk",
        "writeFileSync",
        "tuokecopyAction",
        "map",
        "docid",
        "mmap",
        "create_time",
        "document",
        "detail",
        "info",
        "addnums",
        "updates",
        "doc",
        "islogin",
        "docId",
        "position",
        "cname",
        "mytuokeid",
        "category_id",
        "enrollAction",
        "tuokeAction",
        "uurl",
        "aa",
        "getSignPackage",
        "signPackage",
        "error",
        "str",
        "content",
        "img",
        "image_view",
        "category",
        "cate",
        "extend",
        "title",
        "keywords",
        "keyname",
        "description",
        "split",
        "increment",
        "temp",
        "get_model",
        "model_id",
        "pid",
        "pinfo",
        "i",
        "nav",
        "topid",
        "order",
        "lastinfo",
        "select",
        "plist",
        "field",
        "ptree_",
        "ptree",
        "get_children",
        "type",
        "template",
        "p_id",
        "get_table_name",
        "table",
        "p_info",
        "get_cover2",
        "fmurl",
        "QINIU_DOMAIN_NAME",
        "twourl",
        "undefined",
        "template_m_detail",
        "oid",
        "xfmbAction",
        "twotmp",
        "RegExp",
        "replace"
    ],
    "mappings": "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CA;AACA;;;AAGA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;;AAGA",
    "file": "../../../src/uc/controller/weixin_safe_save_130919.js",
    "sourcesContent": [
        "// +----------------------------------------------------------------------\n// | Bieber [ 美媒网站内容管理框架 ]\n// +----------------------------------------------------------------------\n// | Copyright (c) 2017 http://www.gzxinbibo.com All rights reserved.\n// +----------------------------------------------------------------------\n// | Author: Tony <912697590@qq.com>\n// +----------------------------------------------------------------------\n\n'use strict';\n\nimport Base from './base.js';\nimport pingpp from 'pingpp';\nimport http from 'http';\nimport fs from 'fs';\nimport API from 'wechat-api';\nimport JSSDK from './jssdk.js';\nexport default class extends Base {\n    async __before() {\n            //网站配置\n            // AppID  美媒课堂  wxb2f228dd2a965317\n            // ec9b5b93eb0f7b1d6a32b03e9e2bcf7c\n            this.setup = await this.model(\"setup\").getset();\n            this.api = new API(this.setup.wx_AppID, this.setup.wx_AppSecret);\n            this.jssdk = JSSDK; //new JSSDK(this.setup.wx_AppID, this.setup.wx_AppSecret);\n            this.jssdk.setAppid(this.setup.wx_AppID, this.setup.wx_AppSecret);\n        }\n        /**\n         * index action\n         * @return {Promise} []\n         */\n    indexAction() {\n        //auto render template file index_index.html\n        return this.display();\n    }\n    async oauthAction() {\n            //判断是否是微信浏览器\n            //微信公众账号内自动登陆\n            let openid = await this.session(\"wx_openid\");\n            //openid =null;// await this.session(\"wx_openid\",null);\n\t\t\tconsole.log(\"oauthAction--------\"+openid);\n            if (is_weixin(this.userAgent()) && (think.isEmpty(openid)||typeof openid == 'undefined')) {\n                // 先把url暂存起来\n                this.cookie(\"bieber_wx_url\", this.http.url);\n                var oauthUrl = pingpp.wxPubOauth.createOauthUrlForCode(this.setup.wx_AppID, `${this.setup.wx_url}/uc/weixin/getopenid?showwxpaytitle=1`,true);\n                console.log(\"oauthAction-----------\" + oauthUrl)\n                this.redirect(oauthUrl);\n            }else{\n                let wx_user = await this.model(\"wx_user\").where({ openid: openid }).find();\n                if (think.isEmpty(wx_user)||think.isEmpty(wx_user.uid)) {\n                    let userinfo = await getUser(this.api, openid);\n                    if (think.isEmpty(wx_user)){\n                        await this.model(\"wx_user\").add(userinfo);\n                    }\n                    // this.redirect(\"/uc/weixin/signin\");\n                }\n            }\n\n        }\n        //用微信客户端获取getopenid\n    async getopenidAction() {\n        //获取用户openid\n        let code = this.get(\"code\");\n        console.log(code);\n        //获取openid\n        let getopenid = () => {\n            let deferred = think.defer();\n            pingpp.wxPubOauth.getOpenid(this.setup.wx_AppID, this.setup.wx_AppSecret, code, function(err, openid) {\n                //console.log(openid);\n                deferred.resolve(openid);\n                // ...\n                // pass openid to extra['open_id'] and create a charge\n                // ...\n            });\n            return deferred.promise;\n        };\n        let openid = await getopenid();\n        //9think.log(think.isEmpty(openid));\n        let userinfo = await getUser(this.api, openid);\n        console.log(\"微信 userinfo 123456-------------\"+JSON.stringify(userinfo));\n        //如果没有关注先跳到关注页面\n        // if (userinfo.subscribe == 0) {\n        //    console.log(1111111111111)\n        //    this.redirect('/uc/weixin/follow');\n        //    return false;\n        // };\n        //userinfo.subscribe_time = userinfo.subscribe_time * 1000;\n\t\tuserinfo.subscribe_time = new Date().getTime();\n        let wx_user = await this.model(\"wx_user\").where({ openid: openid }).find();\n\n        //存储Openid\n        await this.session('wx_openid', openid);\n        if (think.isEmpty(wx_user)) {\n\n            await this.model(\"wx_user\").add(userinfo);\n            // this.redirect(\"/uc/weixin/signin\");\n        } else {\n            await this.model(\"wx_user\").where({ openid: openid }).update(userinfo);\n\n            //检查微信号是否跟网站会员绑定\n            if (think.isEmpty(wx_user.uid)) {\n                // 没绑定跳转绑定页面\n               // this.redirect(\"/uc/weixin/signin\");\n\n            } else \n\t\t\t\t\n            {\n                //更新微信头像\n                let filePath = think.RESOURCE_PATH + '/upload/avatar/' + wx_user.uid;\n                think.mkdir(filePath)\n                await this.spiderImage(userinfo.headimgurl, filePath + '/avatar.png')\n                    //绑定直接登陆\n                let last_login_time = await this.model(\"member\").where({ id: wx_user.uid }).getField(\"last_login_time\", true);\n\n                let wx_userInfo = {\n                    'uid': wx_user.uid,\n                    'username': userinfo.nickname,\n                    'last_login_time': last_login_time,\n                };\n                await this.session('webuser', wx_userInfo);\n                // this.redirect(this.cookie(\"bieber_wx_url\"));\n            }\n            \n        }\n        this.redirect(this.cookie(\"bieber_wx_url\"));\n    }\n\n    /**\n     * 没有关注提示关注\n     */\n    async followAction() {\n        //console.log(this.setup)\n        //创建关注二维码\n        //TODO\n        // let titck =await createLimitQRCode(this.api,1);\n        // console.log(titck);\n        let qrcod = this.api.showQRCodeURL(this.setup.wx_two);\n        this.assign(\"qrurl\", qrcod);\n        console.log(\"qrurl============\" + qrcod);\n        //think.log(qrcod);\n        // this.end(qrcod);\n        this.meta_title = `扫码关注`;\n        //判断浏览客户端\n        if (checkMobile(this.userAgent())) {\n            return this.display(`mobile/${this.http.controller}/${this.http.action}`);\n        } else {\n            return this.display();\n        }\n    }\n\n    /**\n     * 微信账号与网站会员绑定\n     */\n    async signinAction() {\n            // await this.session('wx_openid',\"o33lBt0Pz3rEXUARWtUUO5GxuUG0\");\n            let open_id;\n            if (think.isEmpty(this.cookie(\"wx_openid\"))) {\n                open_id = await this.session(\"wx_openid\");\n                this.cookie(\"wx_openid\", open_id);\n            } else {\n                open_id = this.cookie(\"wx_openid\");\n            }\n\n            //清除openid，如果中途失败，可重新激活注册流程\n            await this.session('wx_openid', null);\n            let wx_info = await this.model(\"wx_user\").where({ openid: open_id }).find();\n            this.assign(\"wx_info\", wx_info);\n            this.meta_title = \"完善信息\";\n            this.assign(\"openid\", open_id);\n            this.assign(\"headimgurl\", wx_info.headimgurl)\n                //todo\n            console.log(\"signinAction----\"+`mobile/${this.http.controller}/${this.http.action}`);\n            if (checkMobile(this.userAgent())) {\n                return this.display(`mobile/${this.http.controller}/phone`);\n            } else {\n                return this.display();\n            }\n            // this.end(\"网站会员绑定页面\")\n        }\n        /**完善资料绑定 */\n    async organizingAction() {\n            let data = this.post();\n            //验证\n            let res;\n            if (think.isEmpty(data.username)) {\n                return this.fail(\"用户昵称不能为空！\");\n            } else {\n                res = await this.model(\"member\").where({ username: ltrim(data.username) }).find();\n                if (!think.isEmpty(res)) {\n                    return this.fail(\"用户昵称已存在，请重新填写！\")\n                }\n            }\n            if (think.isEmpty(data.mobile)) {\n                return this.fail(\"手机号码不能为空！\")\n            } else {\n                res = await this.model(\"member\").where({ mobile: data.mobile }).find();\n                if (!think.isEmpty(res)) {\n                    return this.fail(\"手机号码已存在，请重新填写！\")\n                }\n            }\n            if (think.isEmpty(data.email)) {\n                return this.fail(\"电子邮箱不能为空！\")\n            } else {\n                res = await this.model(\"member\").where({ email: data.email }).find();\n                if (!think.isEmpty(res)) {\n                    return this.fail(\"电子邮箱已存在，请重新填写！\")\n                }\n            }\n            if (think.isEmpty(data.password) && think.isEmpty(data.password2)) {\n                return this.fail(\"密码不能为空！\")\n            } else {\n\n                if (data.password != data.password2) {\n                    return this.fail(\"两次输入的密码不一致，请重新填写！\")\n                }\n            }\n            data.status = 1;\n            data.reg_time = new Date().valueOf();\n            data.reg_ip = _ip2int(this.ip());\n            data.password = encryptPassword(data.password);\n            let reg = await this.model(\"member\").add(data);\n\n            if (!think.isEmpty(reg)) {\n                //用户副表\n                await this.model(\"wx_user\").where({ openid: data.openid }).update({ uid: reg });\n                //更新微信头像\n                let filePath = think.RESOURCE_PATH + '/upload/avatar/' + reg;\n                think.mkdir(filePath)\n                await this.spiderImage(data.headimgurl, filePath + '/avatar.png')\n            }\n            console.log(data);\n            await this.model(\"member\").autoLogin({ id: reg }, this.ip()); //更新用户登录信息，自动登陆\n            let wx_userInfo = {\n                'uid': reg,\n                'username': data.username,\n                'last_login_time': data.reg_time,\n            };\n            await this.session('webuser', wx_userInfo);\n            //成功后储存opid,防止无限登陆\n            await this.session('wx_openid', data.openid);\n            this.cookie('wx_openid', null);\n            return this.success({ name: \"绑定成功\", url: \"/uc/index\" });\n\n\n        }\n    async organizingphoneAction() {\n            let data = this.post();\n            //验证\n            let res;\n            let reg ;\n            if (think.isEmpty(data.username)) {\n                return this.fail(\"用户昵称不能为空！\");\n            } else {\n                // res = await this.model(\"member\").where({ username: ltrim(data.username) }).find();\n                // if (!think.isEmpty(res)) {\n                //     return this.fail(\"用户昵称已存在，请重新填写！\")\n                // }\n            }\n            if (think.isEmpty(data.mobile)) {\n                return this.fail(\"手机号码不能为空！\")\n            } else {\n                // res = await this.model(\"wx_user\").where({ phone: data.mobile }).find();\n                // if (!think.isEmpty(res)) {\n                //     return this.fail(\"手机号码已存在，请重新填写！\")\n                // }\n            }\n            // if (think.isEmpty(data.email)) {\n            //     return this.fail(\"电子邮箱不能为空！\")\n            // } else {\n            //     res = await this.model(\"member\").where({ email: data.email }).find();\n            //     if (!think.isEmpty(res)) {\n            //         return this.fail(\"电子邮箱已存在，请重新填写！\")\n            //     }\n            // }\n            // if (think.isEmpty(data.password) && think.isEmpty(data.password2)) {\n            //     return this.fail(\"密码不能为空！\")\n            // } else {\n\n            //     if (data.password != data.password2) {\n            //         return this.fail(\"两次输入的密码不一致，请重新填写！\")\n            //     }\n            // }\n            data.real_name=data.username;\n            data.email=data.mobile+\"@qq.com\";\n            data.password=\"123456\";\n            data.status = 1;\n            data.reg_time = new Date().valueOf();\n            data.reg_ip = _ip2int(this.ip());\n            data.groupid=2;//初级会员\n            data.password = encryptPassword(data.password);\n            res = await this.model(\"member\").where({ mobile: data.mobile }).find();\n            \n            if (!think.isEmpty(res)) {\n                 console.log(\"res member----\"+JSON.stringify(res));\n                 // reg = await this.model(\"member\").where({ mobile: data.mobile }).update(data);\n                 // console.log(\"reg update----\"+JSON.stringify(reg));\n                 reg=res.id;\n            }else{\n                 reg = await this.model(\"member\").add(data);\n                 console.log(\"reg add----\"+JSON.stringify(reg));\n            }\n            \n            // let reg = await this.model(\"wx_user\").where({openid:data.openid}).update(data);\n            if (!think.isEmpty(reg)) {\n                //用户副表\n                await this.model(\"wx_user\").where({ openid: data.openid }).update({ uid: reg,phone:data.mobile });\n                //更新微信头像\n                let filePath = think.RESOURCE_PATH + '/upload/avatar/' + reg;\n                think.mkdir(filePath)\n                await this.spiderImage(data.headimgurl, filePath + '/avatar.png')\n            }\n            console.log(data);\n            await this.model(\"member\").autoLogin({ id: reg }, this.ip()); //更新用户登录信息，自动登陆\n            let wx_userInfo = {\n                'uid': reg,\n                'username': data.username,\n                'last_login_time': data.reg_time,\n            };\n            await this.session('webuser', wx_userInfo);\n            //成功后储存opid,防止无限登陆\n            await this.session('wx_openid', data.openid);\n            this.cookie('wx_openid', null);\n            return this.success({ name: \"绑定成功\", url: this.cookie(\"bieber_wx_url\") });\n\n\n        }\n        /**登录绑定 */\n    async logonbindingAction() {\n            let data = this.post();\n            //console.log(data);\n            let username = this.post('username');\n            let password = this.post('password');\n            password = encryptPassword(password);\n            console.log(data);\n\n            let res = await this.model(\"member\").signin(username, password, this.ip(), 5, 0);\n            if (0 < res.uid) {\n                //记录用户登录行为\n                // await this.model(\"action\",).log(\"user_login\", \"member\", res.uid, res.uid, this.ip(), this.http.url);\n                //console.log(11111111111111);\n                let wx_info = await this.model(\"wx_user\").where({ openid: data.openid }).find();\n                await this.model(\"wx_user\").where({ openid: data.openid }).update({ uid: res.uid });\n                //更新微信头像\n                let filePath = think.RESOURCE_PATH + '/upload/avatar/' + res.uid;\n                think.mkdir(filePath)\n                await this.spiderImage(data.headimgurl, filePath + '/avatar.png')\n                res.username = wx_info.nickname;\n                await this.session('webuser', res);\n                //成功后储存opid,防止无限登陆\n                await this.session('wx_openid', data.openid);\n                this.cookie('wx_openid', null);\n                //TODO 用户密钥\n                return this.success({ name: \"绑定成功\", url: this.cookie(\"bieber_wx_url\") });\n            } else { //登录失败\n                let fail;\n                switch (res) {\n                    case -1:\n                        fail = '用户不存在或被禁用';\n                        break; //系统级别禁用\n                    case -2:\n                        fail = '密码错误';\n                        break;\n                    default:\n                        fail = '未知错误';\n                        break; // 0-接口参数错误（调试阶段使用）\n                }\n                this.fail(fail);\n            }\n        }\n        /**\n         * 更新微信头像\n         */\n    spiderImage(imgUrl, filePath) {\n            let deferred = think.defer();\n            http.get(imgUrl, function(res) {\n                var imgData = \"\";\n                res.setEncoding(\"binary\");\n                res.on(\"data\", function(chunk) {\n                    imgData += chunk;\n                });\n\n                res.on(\"end\", function() {\n                    fs.writeFileSync(filePath, imgData, \"binary\");\n                    deferred.resolve(filePath);\n                });\n            });\n            return deferred.promise;\n        }\n        async tuokecopyAction() {\n\n        // data: {\n        //         \"docid\": did,\n        //         \"name\": user_name.val(),\n        //         \"phone\": user_phone.val(),\n        //         // csrfmiddlewaretoken: $.cookie(\"csrftoken\")\n        //     }\n        if (is_weixin(this.userAgent())) {\n            let data = this.post();\n            console.log(data);\n            let openid = await this.session(\"wx_openid\");\n            \n            //已是微信用户，\n\n            let map = {\n                openid: openid,\n                docid: data.docid\n            };\n            let res = await this.model(\"doc_wxuser\").where(map).find();\n            console.log(res);\n            if (!think.isEmpty(res)) {\n                console.log(\"have---------\" + res);\n                return this.success({ status: 0, name: \"用户已经报名!\" });\n                //已经报名\n            } else {\n\n                let mmap = {\n                    openid: openid,\n                    docid: data.docid,\n                    status: 1,\n                    create_time: new Date().valueOf()\n                }\n                console.log(mmap);\n                res = await this.model(\"doc_wxuser\").add(mmap);\n                //报名人数+1\n                let document = this.model('document');\n                let info = await document.detail(data.docid);\n                info.addnums++;\n                console.log(\"info.nums\" + info.addnums);\n                //报名人数+1\n                let doc = await document.updates(info);\n\n                return this.success({ status: 0, name: \"用户报名成功!\" });\n            }\n        } else {\n            //PC端\n            let data = this.post();\n            console.log(data);\n            let islogin = await this.islogin();\n            if (!islogin) {\n                //未登录，提示登录\n                return this.success({ status: -1, name: \"请先登录，谢谢参与\" });\n            }\n            console.log(\"islogn----------\" + islogin);\n            let document = this.model('document');\n            let info = await document.detail(data.docId);\n            // console.log(\"tuoke info------\"+JSON.stringify(info));\n            if(info.uid==islogin){\n                return this.success({ status: 0, name: \"您已经拥有该拓客模板!\" });\n            }\n            info.uid=islogin;\n            info.id=null;\n            info.create_time=null;\n            info.position=0;\n            let cname=data.cname;\n            let mytuokeid=await this.model('category').where({name:cname}).find();\n            console.log(\"mytuokeid.id===================\"+mytuokeid.id);\n            info.category_id=mytuokeid.id;//我的拓客模板\n            // console.log(\"tuoke info------\"+JSON.stringify(info));\n            let res = await document.updates(info);\n            // // let openid = await this.model(\"wx_user\").where({ uid: islogin }).getField('openid');\n            // // console.log(\"openid----------\" + openid);\n            // // if (think.isEmpty(openid)) {\n            // //     return this.success({ status: -1, name: \"请先关注微信公众号，谢谢参与\" });\n            // // }\n            // let mmap = {\n            //     openid: openid[0],\n            //     docid: data.docid,\n            //     status: 1,\n            //     create_time: new Date().valueOf()\n            // }\n            // console.log(mmap);\n            // await this.model(\"doc_wxuser\").add(mmap);\n            // await this.model(\"wx_user\").where({ openid: openid[0] }).update({ phone: data.phone });\n\n            // let document = this.model('document');\n            // let info = await document.detail(data.docid);\n            // info.addnums++;\n            // console.log(\"info.nums\" + info.addnums);\n            // //报名人数+1\n            // let doc = await document.updates(info);\n            // console.log(\"info.nums doc -----\"+doc);\n            return this.success({ status: 0, name: \"拓客模板拷贝成功!\" });\n        }\n        return this.success({ status: -1, name: \"用户报名失败!\" });\n    }\n        //报名\n    async enrollAction() {\n\n        // data: {\n        //         \"docid\": did,\n        //         \"name\": user_name.val(),\n        //         \"phone\": user_phone.val(),\n        //         // csrfmiddlewaretoken: $.cookie(\"csrftoken\")\n        //     }\n        if (is_weixin(this.userAgent())) {\n            let data = this.post();\n            console.log(data);\n            let openid = await this.session(\"wx_openid\");\n            \n            //已是微信用户，\n\n            let map = {\n                openid: openid,\n                docid: data.docid\n            };\n            let res = await this.model(\"doc_wxuser\").where(map).find();\n            console.log(res);\n            if (!think.isEmpty(res)) {\n                console.log(\"have---------\" + res);\n                return this.success({ status: 0, name: \"用户已经报名!\" });\n                //已经报名\n            } else {\n\n                let mmap = {\n                    openid: openid,\n                    docid: data.docid,\n                    status: 1,\n                    create_time: new Date().valueOf()\n                }\n                console.log(mmap);\n                res = await this.model(\"doc_wxuser\").add(mmap);\n                //报名人数+1\n                let document = this.model('document');\n                let info = await document.detail(data.docid);\n                info.addnums++;\n                console.log(\"info.nums\" + info.addnums);\n                //报名人数+1\n                let doc = await document.updates(info);\n\n                return this.success({ status: 0, name: \"用户报名成功!\" });\n            }\n        } else {\n            //PC端\n            let data = this.post();\n            console.log(data);\n            let islogin = await this.islogin();\n            if (!islogin) {\n                //未登录，提示登录\n                return this.success({ status: -1, name: \"请先登录，谢谢参与\" });\n            }\n            console.log(\"islogn----------\" + islogin);\n            let openid = await this.model(\"wx_user\").where({ uid: islogin }).getField('openid');\n            console.log(\"openid----------\" + openid);\n            if (think.isEmpty(openid)) {\n                return this.success({ status: -1, name: \"请先关注微信公众号，谢谢参与\" });\n            }\n            let mmap = {\n                openid: openid[0],\n                docid: data.docid,\n                status: 1,\n                create_time: new Date().valueOf()\n            }\n            console.log(mmap);\n            await this.model(\"doc_wxuser\").add(mmap);\n            await this.model(\"wx_user\").where({ openid: openid[0] }).update({ phone: data.phone });\n\n            let document = this.model('document');\n            let info = await document.detail(data.docid);\n            info.addnums++;\n            console.log(\"info.nums\" + info.addnums);\n            //报名人数+1\n            let doc = await document.updates(info);\n            // console.log(\"info.nums doc -----\"+doc);\n            return this.success({ status: 0, name: \"用户报名成功!\" });\n        }\n        return this.success({ status: -1, name: \"用户报名失败!\" });\n    }\n\n    async tuokeAction() {\n        let uurl = this.setup.wx_url + this.http.url;\n        console.log(\"url-------------\" + uurl);\n        \n        if (is_weixin(this.userAgent())) {\n            await this.oauthAction();\n            let aa = function(jssdk, url) {\n                let deferred = think.defer();\n                jssdk.getSignPackage(url, (err, signPackage) => {\n                    if (!think.isEmpty(signPackage)) {\n                        deferred.resolve(signPackage);\n                    } else {\n                        console.error(err);\n                    }\n                });\n                return deferred.promise;\n            }\n            let signPackage = await aa(this.jssdk, uurl);\n            console.log(signPackage);\n            this.assign(\"signPackage\", signPackage);\n        }\n\n        let id = this.get(\"id\");\n        console.log(\"id==========\"+id);\n        let document = this.model('document');\n        let info = await document.detail(id);\n        this.assign(\"docid\", id);\n        let islogin = await this.islogin();\n        this.assign(\"userid\", islogin);\n        let str = info.content;\n        if (!think.isEmpty(str)) {\n            let img;\n            if (checkMobile(this.userAgent())) {\n                //手机端\n                img = image_view(str, 640, 4);\n            } else {\n                //pc端\n\n                img = image_view(str, 847, 0);\n            }\n            info.content = img\n        }\n        //console.log(info);\n        //分类信息\n        let cate = await this.category(info.category_id);\n        cate = think.extend({}, cate);\n        //seo\n        this.meta_title = info.title; //标题\n        this.keywords = info.keyname ? info.keyname : ''; //seo关键词\n        this.description = info.description ? info.description : \"\"; //seo描述\n        //keywords\n        let keywords;\n        if (!think.isEmpty(info.keyname)) {\n            keywords = (info.keyname).split(\",\");\n        }\n        this.assign(\"keywords\", keywords);\n        //访问统计\n        await document.where({ id: info.id }).increment('view');\n        //外链\n        // if (!think.isEmpty(info.link_id) && info.link_id != 0) {\n        //     return this.redirect(info.link_id);\n        // }\n        // 获取面包屑信息\n        // let breadcrumb = await this.model('category').get_parent_category(cate.id, true);\n        // this.assign('breadcrumb', breadcrumb);\n\n        // 上一篇\n        // let previous = await document.where({ id: ['>', info.id], category_id: info.category_id, 'pid': 0, 'status': 1 }).order('id DESC').find();\n        // this.assign('previous', previous)\n        //     // 下一篇\n        // let next = await document.where({ id: ['<', info.id], category_id: info.category_id, 'pid': 0, 'status': 1 }).order('id DESC').find();\n        // this.assign('next', next)\n\n        //获取模板\n        let temp;\n        let model = await this.model('model').get_model(info.model_id, 'name');\n        console.log(\"model-------\"+JSON.stringify( model));\n        // 详情模版 TODO\n        // 手机版模版\n\n        this.assign('category', cate);\n       // console.log(info);\n        // 目录/文章/段落\n        let pid;\n        let pinfo;\n        if (info.pid != 0) {\n            let i = info.id;\n            //\n            while (i != 0) {\n                let nav = await document.where({ id: i }).find();\n                if (nav.pid == 0) {\n                    pinfo = nav;\n                    pid = nav.id;\n                }\n                i = nav.pid;\n            }\n\n        } else {\n            pinfo = info;\n            pid = info.id;\n        }\n        // 获取最后更新时间\n        let lastinfo = await document.where({ topid: pid }).order(\"update_time DESC\").find();\n        //console.log(lasttime);\n        this.assign(\"lastinfo\", lastinfo);\n        console.log(pid);\n        let plist = await document.where({ pid: pid }).order(\"level DESC\").select();\n        this.assign(\"pinfo\", pinfo);\n        this.assign(\"plist\", plist);\n        //console.log(plist);\n        if (plist[0]) {\n            //let lastlevel = plist[0].level;\n            //console.log(lastlevel);\n            this.assign(\"lastlevel\", plist[0]);\n        }\n        console.log(plist);\n        // 文档无限级目录\n        let ptree_ = await document.where({ topid: pid }).field('id,title,pid,name,level as sort').select();\n        let ptree = get_children(ptree_, pid, 1);\n        //console.log(ptree);\n        this.assign('topid', pid);\n        this.assign(\"ptree\", ptree);\n\n        // 如果是目录并且模板为空,模块为视频时，目录id，显示最后更新的主题\n        if (info.type == 1 && (think.isEmpty(info.template) || info.template == 0) && info.model_id == 6) {\n            if (plist[0]) {\n                console.log(111111);\n                let model_id = plist[0].model_id;\n                let p_id = plist[0].id;\n                let table = await this.model(\"model\").get_table_name(model_id);\n                let p_info = await this.model(table).find(p_id);\n                info = think.extend(info, p_info);\n\n            }\n        }\n        info.fmurl = await get_cover2(info.fmurl, this.setup.QINIU_DOMAIN_NAME);\n        // console.log(\"tuoke.  pic---------\" + JSON.stringify(pic));\n        // info.fmurl = 'http://' + this.setup.QINIU_DOMAIN_NAME + '/' + pic.path;\n        info.twourl = await get_cover2(info.twourl, this.setup.QINIU_DOMAIN_NAME);\n        // info.twourl = '//' + this.setup.QINIU_DOMAIN_NAME + '/' + pic.path;\n        // console.log(\"tuokeAction---------\" + JSON.stringify(info));\n        // let reg=new RegExp(\"\\\"//*\",\"g\"); //创建正则RegExp对象   \n        // info.content=info.content.replace(reg,\"\\\"http://\");\n        this.assign(\"info\", info);\n        //console.log(\"description-------------\" + info.description);\n        this.assign(\"desc\", info.description);\n        let openid;\n        if (checkMobile(this.userAgent())) {\n            //手机用户\n            openid = await this.session(\"wx_openid\");\n            \n            let map = {\n                openid: openid,\n                docid: id\n            };\n\t\t\t\n            if (typeof openid == 'undefined') {\n                this.assign(\"pay_type\", 0);\n            } else {\n                let res = await this.model(\"doc_wxuser\").where(map).find();\n                console.log(res);\n                //是否已经报名\n                if (res.openid != undefined) {\n                    this.assign(\"pay_type\", 1);\n                } else {\n                    //未报名\n                    this.assign(\"pay_type\", 0);\n                }\n            }\n            //手机模版\n            if (!think.isEmpty(info.template) && info.template != 0) {\n                temp = info.template; //todo 已设置详情模板\n            } else if (!think.isEmpty(cate.template_m_detail)) {\n                temp = cate.template_m_detail; //分类已经设置模板\n            } else {\n                temp = model;\n            }\n\n            //内容分页\n            if (!think.isEmpty(info.content)) {\n                info.content = info.content.split(\"_ueditor_page_break_tag_\");\n            }\n            console.log(\"tuokeAction 手机========\" + `${this.http.controller}/${temp}`);\n            return this.display(`mobile/${this.http.controller}/${temp}`);\n        }\n        if (!islogin) {\n                //未登录，提示登录\n                return this.success({ status: -1, name: \"请先登录，谢谢参与\" });\n        }\n        // PC用户\n        let oid = await this.model(\"wx_user\").where({ uid: islogin }).find();\n        if (!think.isEmpty(oid)) {\n            console.log(\"PC用户--------------\" + oid);\n            openid = oid.openid;\n            let map = {\n                openid: openid,\n                docid: id\n            };\n            console.log(\"PC用户 oid,--------------\" + JSON.stringify(map));\n            let res = await this.model(\"doc_wxuser\").where(map).find();\n            //是否已经报名\n            if (!think.isEmpty(res)) {\n                this.assign(\"pay_type\", 1);\n            } else {\n                //未报名\n                this.assign(\"pay_type\", 0);\n            }\n        } else {\n            //未报名\n            this.assign(\"pay_type\", 0);\n        }\n        // if (!think.isEmpty(info.template) && info.template != 0) {\n        //     temp = info.template; //已设置详情模板\n        // } else if (!think.isEmpty(cate.template_detail)) {\n        //     temp = cate.template_detail; //分类已经设置模板\n        // } else {\n        //     temp = model;\n        // }\n        // console.log(temp);\n        //console.log(info);\n        //内容分页\n        if (!think.isEmpty(info.content)) {\n            info.content = info.content.split(\"_ueditor_page_break_tag_\");\n        }\n\n        // if(model==\"myshop\"){\n        //     return this.display(`${this.http.controller}/myshop`);\n        // }\n        if (!think.isEmpty(info.template) && info.template != 0) {\n                temp = info.template; //todo 已设置详情模板\n            } else if (!think.isEmpty(cate.template_m_detail)) {\n                temp = cate.template_m_detail; //分类已经设置模板\n            } else {\n                temp = model;\n            }\n        console.log(\"tuokeAction========\" + `${this.http.controller}/${temp}`);\n        return this.display(`${this.http.controller}/${temp}`);\n\n\n    }\n    async xfmbAction() {\n        let uurl = this.setup.wx_url + this.http.url;\n        console.log(\"url-------------\" + uurl);\n        \n        if (is_weixin(this.userAgent())) {\n            await this.oauthAction();\n            let aa = function(jssdk, url) {\n                let deferred = think.defer();\n                jssdk.getSignPackage(url, (err, signPackage) => {\n                    if (!think.isEmpty(signPackage)) {\n                        deferred.resolve(signPackage);\n                    } else {\n                        console.error(err);\n                    }\n                });\n                return deferred.promise;\n            }\n            let signPackage = await aa(this.jssdk, uurl);\n            console.log(signPackage);\n            this.assign(\"signPackage\", signPackage);\n        }\n\n        let id = this.get(\"id\");\n        console.log(\"id==========   111222,,,\"+id);\n        let document = this.model('document');\n        let info = await document.detail(id);\n        this.assign(\"docid\", id);\n        let islogin = await this.islogin();\n        this.assign(\"userid\", islogin);\n        let str = info.content;\n        if (!think.isEmpty(str)) {\n            let img;\n            if (checkMobile(this.userAgent())) {\n                //手机端\n                img = image_view(str, 640, 4);\n            } else {\n                //pc端\n\n                img = image_view(str, 847, 0);\n            }\n            info.content = img\n        }\n        //console.log(info);\n        //分类信息\n        let cate = await this.category(info.category_id);\n        cate = think.extend({}, cate);\n        //seo\n        this.meta_title = info.title; //标题\n        this.keywords = info.keyname ? info.keyname : ''; //seo关键词\n        this.description = info.description ? info.description : \"\"; //seo描述\n        //keywords\n        let keywords;\n        if (!think.isEmpty(info.keyname)) {\n            keywords = (info.keyname).split(\",\");\n        }\n        this.assign(\"keywords\", keywords);\n        //访问统计\n        await document.where({ id: info.id }).increment('view');\n        \n        //获取模板\n        let temp;\n        let model = await this.model('model').get_model(info.model_id, 'name');\n        console.log(\"model-------\"+JSON.stringify( model));\n        // 详情模版 TODO\n        // 手机版模版\n\n        this.assign('category', cate);\n       // console.log(info);\n        // 目录/文章/段落\n        let pid;\n        let pinfo;\n        if (info.pid != 0) {\n            let i = info.id;\n            //\n            while (i != 0) {\n                let nav = await document.where({ id: i }).find();\n                if (nav.pid == 0) {\n                    pinfo = nav;\n                    pid = nav.id;\n                }\n                i = nav.pid;\n            }\n\n        } else {\n            pinfo = info;\n            pid = info.id;\n        }\n        // 获取最后更新时间\n        let lastinfo = await document.where({ topid: pid }).order(\"update_time DESC\").find();\n        //console.log(lasttime);\n        this.assign(\"lastinfo\", lastinfo);\n        console.log(pid);\n        let plist = await document.where({ pid: pid }).order(\"level DESC\").select();\n        this.assign(\"pinfo\", pinfo);\n        this.assign(\"plist\", plist);\n        //console.log(plist);\n        if (plist[0]) {\n            //let lastlevel = plist[0].level;\n            //console.log(lastlevel);\n            this.assign(\"lastlevel\", plist[0]);\n        }\n        console.log(plist);\n        // 文档无限级目录\n        let ptree_ = await document.where({ topid: pid }).field('id,title,pid,name,level as sort').select();\n        let ptree = get_children(ptree_, pid, 1);\n        //console.log(ptree);\n        this.assign('topid', pid);\n        this.assign(\"ptree\", ptree);\n\n        // 如果是目录并且模板为空,模块为视频时，目录id，显示最后更新的主题\n        if (info.type == 1 && (think.isEmpty(info.template) || info.template == 0) && info.model_id == 6) {\n            if (plist[0]) {\n                console.log(111111);\n                let model_id = plist[0].model_id;\n                let p_id = plist[0].id;\n                let table = await this.model(\"model\").get_table_name(model_id);\n                let p_info = await this.model(table).find(p_id);\n                info = think.extend(info, p_info);\n\n            }\n        }\n        info.fmurl = await get_cover2(info.fmurl, this.setup.QINIU_DOMAIN_NAME);\n        // console.log(\"tuoke.  pic---------\" + JSON.stringify(pic));\n        // info.fmurl = 'http://' + this.setup.QINIU_DOMAIN_NAME + '/' + pic.path;\n        info.twourl = await get_cover2(info.twourl, this.setup.QINIU_DOMAIN_NAME);\n        info.twotmp = await get_cover2(info.twotmp, this.setup.QINIU_DOMAIN_NAME);\n        // info.twourl = '//' + this.setup.QINIU_DOMAIN_NAME + '/' + pic.path;\n        let reg=new RegExp(\"\\\"//*\",\"g\"); //创建正则RegExp对象   \n        info.content=info.content.replace(reg,\"\\\"http://\");\n        console.log(\"info---------\" + JSON.stringify(info));\n        this.assign(\"info\", info);\n        //console.log(\"description-------------\" + info.description);\n        this.assign(\"desc\", info.description);\n        let openid;\n        if (checkMobile(this.userAgent())) {\n            //手机用户\n            openid = await this.session(\"wx_openid\");\n            \n            let map = {\n                openid: openid,\n                docid: id\n            };\n            \n            if (typeof openid == 'undefined') {\n                this.assign(\"pay_type\", 0);\n            } else {\n                let res = await this.model(\"doc_wxuser\").where(map).find();\n                console.log(res);\n                //是否已经报名\n                if (res.openid != undefined) {\n                    this.assign(\"pay_type\", 1);\n                } else {\n                    //未报名\n                    this.assign(\"pay_type\", 0);\n                }\n            }\n            //手机模版\n            if (!think.isEmpty(info.template) && info.template != 0) {\n                temp = info.template; //todo 已设置详情模板\n            } else if (!think.isEmpty(cate.template_m_detail)) {\n                temp = cate.template_m_detail; //分类已经设置模板\n            } else {\n                temp = model;\n            }\n\n            //内容分页\n            if (!think.isEmpty(info.content)) {\n                info.content = info.content.split(\"_ueditor_page_break_tag_\");\n            }\n            console.log(\"tuokeAction 手机========\" + `${this.http.controller}/${temp}`);\n            return this.display(`mobile/${this.http.controller}/${temp}`);\n        }\n        if (!islogin) {\n                //未登录，提示登录\n                return this.success({ status: -1, name: \"请先登录，谢谢参与\" });\n        }\n        // PC用户\n        let oid = await this.model(\"wx_user\").where({ uid: islogin }).find();\n        if (!think.isEmpty(oid)) {\n            console.log(\"PC用户--------------\" + oid);\n            openid = oid.openid;\n            let map = {\n                openid: openid,\n                docid: id\n            };\n            console.log(\"PC用户 oid,--------------\" + JSON.stringify(map));\n            let res = await this.model(\"doc_wxuser\").where(map).find();\n            //是否已经报名\n            if (!think.isEmpty(res)) {\n                this.assign(\"pay_type\", 1);\n            } else {\n                //未报名\n                this.assign(\"pay_type\", 0);\n            }\n        } else {\n            //未报名\n            this.assign(\"pay_type\", 0);\n        }\n        //内容分页\n        if (!think.isEmpty(info.content)) {\n            info.content = info.content.split(\"_ueditor_page_break_tag_\");\n        }\n\n        console.log(\"tuokeAction========\" + `${this.http.controller}/${model}`);\n        return this.display(`${this.http.controller}/${model}`);\n\n\n    }\n    // async musicAction() {\n    //     let uurl = this.setup.wx_url + this.http.url;\n    //     console.log(\"music url-------------\" + uurl);\n        \n    //     if (is_weixin(this.userAgent())) {\n    //         await this.oauthAction();\n    //         let aa = function(jssdk, url) {\n    //             let deferred = think.defer();\n    //             jssdk.getSignPackage(url, (err, signPackage) => {\n    //                 if (!think.isEmpty(signPackage)) {\n    //                     deferred.resolve(signPackage);\n    //                 } else {\n    //                     console.error(err);\n    //                 }\n    //             });\n    //             return deferred.promise;\n    //         }\n    //         let signPackage = await aa(this.jssdk, uurl);\n    //         console.log(signPackage);\n    //         this.assign(\"signPackage\", signPackage);\n    //     }\n\n    //     let id = this.get(\"id\");\n    //     console.log(\"id==========\"+id);\n    //     let document = this.model('document');\n    //     let info = await document.detail(id);\n    //     this.assign(\"docid\", id);\n    //     let islogin = await this.islogin();\n    //     this.assign(\"userid\", islogin);\n    //     let str = info.content;\n    //     if (!think.isEmpty(str)) {\n    //         let img;\n    //         if (checkMobile(this.userAgent())) {\n    //             //手机端\n    //             img = image_view(str, 640, 4);\n    //         } else {\n    //             //pc端\n\n    //             img = image_view(str, 847, 0);\n    //         }\n    //         info.content = img\n    //     }\n    //     //console.log(info);\n    //     //分类信息\n    //     let cate = await this.category(info.category_id);\n    //     cate = think.extend({}, cate);\n    //     //seo\n    //     this.meta_title = info.title; //标题\n    //     this.keywords = info.keyname ? info.keyname : ''; //seo关键词\n    //     this.description = info.description ? info.description : \"\"; //seo描述\n    //     //keywords\n    //     let keywords;\n    //     if (!think.isEmpty(info.keyname)) {\n    //         keywords = (info.keyname).split(\",\");\n    //     }\n    //     this.assign(\"keywords\", keywords);\n    //     //访问统计\n    //     await document.where({ id: info.id }).increment('view');\n    //     //外链\n        \n\n    //     //获取模板\n    //     let temp;\n    //     let model = await this.model('model').get_model(info.model_id, 'name');\n    //     console.log(\"model-------\"+JSON.stringify( model));\n    //     // 详情模版 TODO\n    //     // 手机版模版\n\n    //     this.assign('category', cate);\n    //    // console.log(info);\n    //     // 目录/文章/段落\n    //     let pid;\n    //     let pinfo;\n    //     if (info.pid != 0) {\n    //         let i = info.id;\n    //         //\n    //         while (i != 0) {\n    //             let nav = await document.where({ id: i }).find();\n    //             if (nav.pid == 0) {\n    //                 pinfo = nav;\n    //                 pid = nav.id;\n    //             }\n    //             i = nav.pid;\n    //         }\n\n    //     } else {\n    //         pinfo = info;\n    //         pid = info.id;\n    //     }\n    //     // 获取最后更新时间\n    //     let lastinfo = await document.where({ topid: pid }).order(\"update_time DESC\").find();\n    //     //console.log(lasttime);\n    //     this.assign(\"lastinfo\", lastinfo);\n    //     console.log(pid);\n    //     let plist = await document.where({ pid: pid }).order(\"level DESC\").select();\n    //     this.assign(\"pinfo\", pinfo);\n    //     this.assign(\"plist\", plist);\n    //     //console.log(plist);\n    //     if (plist[0]) {\n    //         //let lastlevel = plist[0].level;\n    //         //console.log(lastlevel);\n    //         this.assign(\"lastlevel\", plist[0]);\n    //     }\n    //     console.log(plist);\n    //     // 文档无限级目录\n    //     let ptree_ = await document.where({ topid: pid }).field('id,title,pid,name,level as sort').select();\n    //     let ptree = get_children(ptree_, pid, 1);\n    //     //console.log(ptree);\n    //     this.assign('topid', pid);\n    //     this.assign(\"ptree\", ptree);\n\n    //     // 如果是目录并且模板为空,模块为视频时，目录id，显示最后更新的主题\n    //     if (info.type == 1 && (think.isEmpty(info.template) || info.template == 0) && info.model_id == 6) {\n    //         if (plist[0]) {\n    //             console.log(111111);\n    //             let model_id = plist[0].model_id;\n    //             let p_id = plist[0].id;\n    //             let table = await this.model(\"model\").get_table_name(model_id);\n    //             let p_info = await this.model(table).find(p_id);\n    //             info = think.extend(info, p_info);\n\n    //         }\n    //     }\n    //     info.fmurl = await get_cover2(info.fmurl, this.setup.QINIU_DOMAIN_NAME);\n    //     // console.log(\"tuoke.  pic---------\" + JSON.stringify(pic));\n    //     // info.fmurl = 'http://' + this.setup.QINIU_DOMAIN_NAME + '/' + pic.path;\n    //     info.twourl = await get_cover2(info.twourl, this.setup.QINIU_DOMAIN_NAME);\n    //     // info.twourl = '//' + this.setup.QINIU_DOMAIN_NAME + '/' + pic.path;\n    //     // console.log(\"tuokeAction---------\" + JSON.stringify(info));\n    //     this.assign(\"info\", info);\n    //     //console.log(\"description-------------\" + info.description);\n    //     this.assign(\"desc\", info.description);\n    //     let openid;\n    //     if (checkMobile(this.userAgent())) {\n    //         //手机用户\n    //         openid = await this.session(\"wx_openid\");\n            \n    //         let map = {\n    //             openid: openid,\n    //             docid: id\n    //         };\n            \n    //         if (typeof openid == 'undefined') {\n    //             this.assign(\"pay_type\", 0);\n    //         } else {\n    //             let res = await this.model(\"doc_wxuser\").where(map).find();\n    //             console.log(res);\n    //             //是否已经报名\n    //             if (res.openid != undefined) {\n    //                 this.assign(\"pay_type\", 1);\n    //             } else {\n    //                 //未报名\n    //                 this.assign(\"pay_type\", 0);\n    //             }\n    //         }\n    //         //手机模版\n    //         if (!think.isEmpty(info.template) && info.template != 0) {\n    //             temp = info.template; //todo 已设置详情模板\n    //         } else if (!think.isEmpty(cate.template_m_detail)) {\n    //             temp = cate.template_m_detail; //分类已经设置模板\n    //         } else {\n    //             temp = model;\n    //         }\n\n    //         //内容分页\n    //         if (!think.isEmpty(info.content)) {\n    //             info.content = info.content.split(\"_ueditor_page_break_tag_\");\n    //         }\n    //         console.log(\"tuokeAction 手机========\" + `${this.http.controller}/${temp}`);\n    //         return this.display(`mobile/${this.http.controller}/${temp}`);\n    //     }\n    //     if (!islogin) {\n    //             //未登录，提示登录\n    //             return this.success({ status: -1, name: \"请先登录，谢谢参与\" });\n    //     }\n    //     // PC用户\n    //     let oid = await this.model(\"wx_user\").where({ uid: islogin }).find();\n    //     if (!think.isEmpty(oid)) {\n    //         console.log(\"PC用户--------------\" + oid);\n    //         openid = oid.openid;\n    //         let map = {\n    //             openid: openid,\n    //             docid: id\n    //         };\n    //         console.log(\"PC用户 oid,--------------\" + JSON.stringify(map));\n    //         let res = await this.model(\"doc_wxuser\").where(map).find();\n    //         //是否已经报名\n    //         if (!think.isEmpty(res)) {\n    //             this.assign(\"pay_type\", 1);\n    //         } else {\n    //             //未报名\n    //             this.assign(\"pay_type\", 0);\n    //         }\n    //     } else {\n    //         //未报名\n    //         this.assign(\"pay_type\", 0);\n    //     }\n    //     // if (!think.isEmpty(info.template) && info.template != 0) {\n    //     //     temp = info.template; //已设置详情模板\n    //     // } else if (!think.isEmpty(cate.template_detail)) {\n    //     //     temp = cate.template_detail; //分类已经设置模板\n    //     // } else {\n    //     //     temp = model;\n    //     // }\n    //     // console.log(temp);\n    //     //console.log(info);\n    //     //内容分页\n    //     if (!think.isEmpty(info.content)) {\n    //         info.content = info.content.split(\"_ueditor_page_break_tag_\");\n    //     }\n\n    //     // if(model==\"myshop\"){\n    //     //     return this.display(`${this.http.controller}/myshop`);\n    //     // }\n    //     console.log(\"musicAction========\" + `${this.http.controller}/${model}`);\n    //     return this.display(`${this.http.controller}/${model}`);\n\n\n    // }\n}\n"
    ]
}
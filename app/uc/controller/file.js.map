{
    "version": 3,
    "sources": [
        "../../../src/uc/controller/file.js"
    ],
    "names": [
        "fs",
        "path",
        "indexAction",
        "display",
        "uploadAction",
        "file",
        "think",
        "extend",
        "filepath",
        "basename",
        "data",
        "setup",
        "IS_QINIU",
        "qiniu",
        "service",
        "instance",
        "uploadpic",
        "uppic",
        "console",
        "log",
        "isEmpty",
        "create_time",
        "Date",
        "getTime",
        "name",
        "originalFilename",
        "savename",
        "mime",
        "headers",
        "size",
        "location",
        "sha1",
        "hash",
        "md5",
        "uploadPath",
        "RESOURCE_PATH",
        "dateformat",
        "mkdir",
        "renameSync",
        "isFile",
        "savepath",
        "model",
        "add",
        "res",
        "json",
        "id",
        "uploadpicAction",
        "type",
        "get",
        "ret",
        "status",
        "key",
        "get_pic",
        "picsAction",
        "selectpicAction",
        "limit",
        "select",
        "pics",
        "assign",
        "selecturlAction",
        "savenetpicAction",
        "config",
        "fieldName",
        "urlstr",
        "post",
        "up",
        "adapter",
        "upload",
        "saveRemote",
        "info",
        "url",
        "getpicAction",
        "get_cover",
        "pic",
        "end",
        "getqiniuuptokenAction",
        "uuid",
        "uptoken",
        "qiniuaddAction",
        "delqiniufileAction",
        "find",
        "remove",
        "where",
        "delete",
        "success",
        "fail"
    ],
    "mappings": "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",
    "file": "../../../src/uc/controller/file.js",
    "sourcesContent": [
        "// +----------------------------------------------------------------------\n// | Bieber [ 美媒网站内容管理框架 ]\n// +----------------------------------------------------------------------\n// | Copyright (c) 2017 http://www.gzxinbibo.com All rights reserved.\n// +----------------------------------------------------------------------\n// | Author: Tony <912697590@qq.com>\n// +----------------------------------------------------------------------\n'use strict';\n\nimport Base from './base.js';\nimport * as fs from 'fs';\nimport * as path from 'path';\nexport default class extends Base {\n  /**\n   * index action\n   * @return {Promise} []\n   */\n  indexAction(){\n    //auto render template file index_index.html\n    return this.display();\n  }\n  //上传文件\n  async uploadAction(){\n\n      let file = think.extend({}, this.file('file'));\n    let filepath = file.path;\n    let basename = path.basename(filepath);\n      let data;\n      //强势插入七牛\n      if(this.setup.IS_QINIU == 1){\n          let qiniu = think.service(\"qiniu\");\n          let instance = new qiniu();\n          let uppic = await instance.uploadpic(filepath,basename);\n          console.log(uppic);\n          // { fieldName: 'file',\n          //     originalFilename: '2015-07-06_BaiduPlayerNetSetup_100.exe',\n          //     path: '/Users/Arterli/Projects/CmsWing/runtime/upload/EPKRrpZvCsSV73J-7kuDiiEY.exe',\n          //     headers:\n          //     { 'content-disposition': 'form-data; name=\"file\"; filename=\"2015-07-06_BaiduPlayerNetSetup_100.exe\"',\n          //         'content-type': 'application/x-msdownload' },\n          //     size: 1292280 }\n          if(!think.isEmpty(uppic)){\n               data ={\n                  create_time:new Date().getTime(),\n                  name:file.originalFilename,\n                  savename:basename,\n                  mime:file.headers[\"content-type\"],\n                  size:file.size,\n                  location:1,\n                  sha1:uppic.hash,\n                  md5:think.md5(basename)\n              }\n          }\n          //return false;\n      }else {\n          let uploadPath = think.RESOURCE_PATH + '/upload/download/'+dateformat(\"Y-m-d\",new Date().getTime());\n          think.mkdir(uploadPath);\n          fs.renameSync(filepath, uploadPath + '/' + basename);\n          file.path = uploadPath + '/' + basename;\n          if(think.isFile(file.path)){\n              data ={\n                  savepath:'/upload/download/'+dateformat(\"Y-m-d\",new Date().getTime())+ '/',\n                  create_time:new Date().getTime(),\n                  name:file.originalFilename,\n                  savename:basename,\n                  mime:file.headers[\"content-type\"],\n                  size:file.size,\n                  md5:think.md5(basename)\n              }\n      }\n\n    }\n      console.log(data);\n      var res = await this.model(\"file\").data(data).add();\n    this.json({id:res,size:file.size});\n  }\n\n  //上传图片\n    /**\n     * 上传图片统一接口\n     * ／uc/file/uploadpic\n     * 默认上传返回 图片id,展示图片请用 get_pic(id)函数\n     * /uc/file/uploadpic/type/path\n     * 返回图片地址,\n     *\n     */\n  async uploadpicAction(){\n      let type = this.get('type');\n    let file = think.extend({}, this.file('file'));\n    let filepath = file.path;\n    let basename = path.basename(filepath);\n    let ret = {'status':1,'info':'上传成功','data':\"\"}\n      let res;\n      //加入七牛接口\n    if(this.setup.IS_QINIU==1){\n        let qiniu = think.service(\"qiniu\");\n        let instance = new qiniu();\n         let uppic = await instance.uploadpic(filepath,basename);\n        if(!think.isEmpty(uppic)){\n            let data ={\n                create_time:new Date().getTime(),\n                status:1,\n                type:2,\n                sha1:uppic.hash,\n                path:uppic.key\n\n            };\n           res = await this.model(\"picture\").data(data).add();\n        }\n    } else {\n        let uploadPath = think.RESOURCE_PATH + '/upload/picture/'+dateformat(\"Y-m-d\",new Date().getTime());\n        think.mkdir(uploadPath);\n        if(think.isFile(filepath)){\n            fs.renameSync(filepath, uploadPath + '/' + basename);\n        }else {\n            console.log(\"文件不存在！\")\n        }\n        file.path = uploadPath + '/' + basename;\n        if(think.isFile(file.path)){\n            let data ={\n                path:'/upload/picture/'+dateformat(\"Y-m-d\",new Date().getTime())+ '/' + basename,\n                create_time:new Date().getTime(),\n                status:1,\n\n            }\n             res = await this.model(\"picture\").data(data).add();\n        }else{\n            console.log('not exist')\n        }\n    }\n\n        if(type=='path'){\n         this.json(await get_pic(res));\n    }else {\n         this.json(res);\n    }\n\n  }\n  //上传多图\n  picsAction(){\n      let file = think.extend({},this.file('file'));\n      console.log(file);\n  }\n  //图片选择\n  async selectpicAction(){\n    let pics = await this.model(\"picture\").limit(2, 15).select();\n    this.assign(\"pics\", pics);\n    this.assign(\"field\", {\"name\":\"uploadimg\"});\n    this.display();\n  }\n\n  //链接选择\n  selecturlAction(){\n    this.assign(\"articles\", [1, 2, 3, 4, 5, 6]);\n    this.display();\n  }\n\n  async savenetpicAction(){\n    //抓取远程图片\n      /* 上传配置 */\n      this.config = this.config(\"ueditor\");\n      let config = {\n        \"pathFormat\" : this.config['catcherPathFormat'],\n        \"maxSize\" : this.config['catcherMaxSize'],\n        \"allowFiles\" : this.config['catcherAllowFiles'],\n        \"oriName\" : \"remote.png\"\n      };\n      let fieldName = this.config['catcherFieldName'];\n      let urlstr = this.post(\"picurl\");\n      let up = think.adapter(\"editor\", \"ueditor\"); //加载名为 ueditor 的 editor Adapter\n      let upload = new up(urlstr, config, \"remote\"); //实例化 Adapter\n      let info =  await upload.saveRemote();\n      console.log(info);\n     // let obj = {\"state\":\"SUCCESS\",\"url\":info.url,\"size\":431521,\"title\":info.title,\"original\":info.original,\"source\":imgUrl};\n      let data ={\n        path:info.url,\n        create_time:new Date().getTime(),\n        status:1\n      }\n      let res = await this.model(\"picture\").data(data).add();\n      if(res)\n      {\n        data.id = res;\n       return this.json(data);\n      }\n      else\n      {\n        return this.json({\"status\":0});\n      }\n\n  }\n\n  //根据图片id获取图片信息\n  async getpicAction(){\n      let id = this.post(\"id\");\n    //let pic = await this.model(\"picture\").where({\"id\":parseInt(this.post(\"id\"))}).find();\n      let pic = await get_cover(id);\n    this.end(pic);\n  }\n    //获取七牛token\n   async getqiniuuptokenAction (){\n        let qiniu = think.service(\"qiniu\");\n        let instance = new qiniu();\n       let key = think.uuid();\n       let uptoken = await instance.uploadpic(null,key,true);\n       this.json({\n           \"uptoken\": uptoken\n       })\n    }\n    //添加\n    async qiniuaddAction(){\n        let post = this.post();\n        let data ={\n            create_time:new Date().getTime(),\n            name:post.key,\n            savename:post.key,\n            mime:post.mime,\n            size:post.size,\n            location:1,\n            sha1:post.hash,\n            md5:think.md5(post.id)\n        }\n        //console.log(data);\n        let res = await this.model(\"file\").data(data).add();\n        return this.json(res);\n    }\n    //删除七牛资源\n    async delqiniufileAction(){\n        let id = this.get(\"id\");\n        let file = await this.model(\"file\").find(id);\n        let qiniu = think.service(\"qiniu\");\n        let instance = new qiniu();\n        let res = await instance.remove(file.savename);\n        if(res) {\n            this.model(\"file\").where({id:id}).delete();\n            return this.success({name: \"删除文件成功!\"})\n        }else {\n            return this.fail( \"删除文件失败!\")\n        }\n    }\n}\n"
    ]
}
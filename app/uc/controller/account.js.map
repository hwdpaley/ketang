{
    "version": 3,
    "sources": [
        "../../../src/uc/controller/account.js"
    ],
    "names": [
        "locale",
        "indexAction",
        "weblogin",
        "type",
        "get",
        "data",
        "think",
        "isEmpty",
        "model",
        "where",
        "user_id",
        "user",
        "uid",
        "page",
        "param",
        "order",
        "countSelect",
        "is_del",
        "val",
        "id",
        "payment",
        "getField",
        "channel",
        "html",
        "http",
        "desc",
        "pageNum",
        "url",
        "class",
        "text",
        "next",
        "prev",
        "total",
        "assign",
        "count",
        "find",
        "userInfo",
        "pay_status",
        "unpaid",
        "meta_title",
        "checkMobile",
        "userAgent",
        "isAjax",
        "v",
        "time",
        "create_time",
        "format",
        "amount",
        "formatCurrency",
        "amount_log",
        "json",
        "active",
        "display",
        "controller",
        "action",
        "rechargeAction",
        "post",
        "order_amount",
        "fail",
        "isNumberString",
        "nowtime",
        "Date",
        "valueOf",
        "oid",
        "order_no",
        "join",
        "status",
        "open_id",
        "session",
        "service",
        "pay",
        "pingxx",
        "ip",
        "charges",
        "pingxx_id",
        "add",
        "order_id",
        "receiving",
        "getTime",
        "payment_time",
        "doc_type",
        "payment_id",
        "success",
        "name",
        "map",
        "is_weixin",
        "select",
        "paylist"
    ],
    "mappings": "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",
    "file": "../../../src/uc/controller/account.js",
    "sourcesContent": [
        "// +----------------------------------------------------------------------\n// | Bieber [ 美媒网站内容管理框架 ]\n// +----------------------------------------------------------------------\n// | Copyright (c) 2017 http://www.gzxinbibo.com All rights reserved.\n// +----------------------------------------------------------------------\n// | Author: Tony <912697590@qq.com>\n// +----------------------------------------------------------------------\n'use strict';\nimport moment from \"moment\"\nmoment.locale('zh-cn');\nimport Base from './base.js';\nimport pagination from 'think-pagination';\nexport default class extends Base {\n  /**\n   * 账户金额管理\n   * @returns {PreventPromise}\n   */\n  async indexAction() {\n    //判断是否登陆\n    await this.weblogin();\n    let type = this.get(\"type\") || null;\n    let data;\n    if (think.isEmpty(type)) {\n      data = await this.model(\"balance_log\").where({user_id: this.user.uid}).page(this.param('page')).order(\"time DESC\").countSelect();\n    } else if (type == 1) {\n      data = await this.model(\"balance_log\").where({user_id: 10000}).page(this.param('page')).order(\"time DESC\").countSelect();\n    } else {\n      data = await this.model(\"order\").where({\n        user_id: this.user.uid,\n        type: 1,\n        is_del: 0\n      }).page(this.get('page')).order(\"create_time DESC\").countSelect();\n      for (let val of data.data) {\n\n        val.channel = await this.model(\"pingxx\").where({id: val.payment}).getField(\"title\", true);\n      }\n    }\n\n    let html = pagination(data, this.http, {\n      desc: false, //show description\n      pageNum: 2,\n      url: '', //page url, when not set, it will auto generated\n      class: 'nomargin', //pagenation extra class\n      text: {\n        next: '下一页',\n        prev: '上一页',\n        total: 'count: ${count} , pages: ${pages}'\n      }\n    });\n    //think.log(data);\n    this.assign('pagination', html);\n    this.assign(\"list\", data.data);\n    this.assign(\"type\", type);\n    this.assign(\"count\",data.count)\n    //获取用户信息\n    let userInfo = await this.model(\"member\").find(this.user.uid);\n    this.assign(\"userInfo\", userInfo);\n    //未付款的充值订单统计\n    let unpaid = await this.model(\"order\").where({\n      user_id: this.user.uid,\n      type: 1,\n      is_del: 0,\n      pay_status: 0\n    }).count(\"id\");\n    this.assign(\"unpaid\", unpaid);\n    this.meta_title = \"账户金额管理\";\n    //判断浏览客户端\n    if (checkMobile(this.userAgent())) {\n\n      if(this.isAjax(\"get\")){\n        for(let v of data.data){\n          v.time =moment(v.create_time).format('YYYY-MM-DD HH:mm:ss');\n          v.amount = formatCurrency(v.amount);\n          v.amount_log = formatCurrency(v.amount_log);\n        }\n        return this.json(data);\n      }else {\n        this.active = \"user/index\";\n        return this.display(`mobile/${this.http.controller}/${this.http.action}`)\n      }\n\n    } else {\n      return this.display();\n    }\n  }\n\n  /**\n   * 充值\n   */\n  async rechargeAction() {\n    //判断是否登陆\n    await this.weblogin();\n    if (this.isAjax(\"POST\")) {\n      let data = this.post();\n      if (think.isEmpty(data.order_amount)) {\n        return this.fail(\"请输入金额！\");\n      } else if (!think.isNumberString(data.order_amount)) {\n        return this.fail(\"金额类型错误！\")\n      } else if (think.isEmpty(data.payment)) {\n        return this.fail(\"必须选一种支付方式！\")\n      }\n\n      //用户\n      data.user_id = this.user.uid;\n      //生成订单编号//todo\n      let nowtime = new Date().valueOf();\n      let oid = [\"c\", this.user.uid, nowtime]\n      data.order_no = oid.join(\"\");\n      //支付状态 pay_stayus 0:未付款 ,1:已付款\n      data.pay_status = 0;\n      //订单状态 status 2:等待审核，3:已审核\n      data.status = 2;\n      //发货状态 type 0:普通，1:充值\n      data.type = 1;\n      //订单创建时间 create_time\n      data.create_time = new Date().valueOf();\n      //生成订单\n\n      //判断是否已经绑定pingxx_id,如果已绑定查询pingxx订单直接支付。防止订单重复生成。\n      // console.log(111111111)\n      //获取渠道\n      let channel = await this.model(\"pingxx\").where({id: data.payment}).getField(\"channel\", true);\n      let open_id;\n      if(channel == \"wx_pub\"){\n        open_id=await this.session(\"wx_openid\")\n      }\n      //调用ping++ 服务端\n      let payment = think.service(\"payment\");\n      let pay = new payment(this.http);\n      //传入 channel,order_no,order_amount,this.ip()\n      let charges = await pay.pingxx(channel, data.order_no, data.order_amount, this.ip(),open_id);\n\n\n      //console.log(charges);\n      if (charges) {\n        //把pingxx_id存到订单\n        data.pingxx_id = charges.id;\n        let order_id = await this.model(\"order\").add(data);\n\n        //支付日志\n        let receiving = {\n          order_id: order_id,\n          user_id: this.user.uid,\n          amount: data.order_amount,\n          create_time: new Date().getTime(),\n          payment_time: new Date().getTime(),\n          doc_type: 1,\n          payment_id: data.payment,\n          pay_status: 0\n        }\n        await this.model(\"doc_receiving\").add(receiving);\n        return this.success({name: \"支付订单对接成功，正在转跳！\", data: charges})\n      } else {\n        return this.fail(\"调用接口失败！\");\n      }\n      // think.log(data);\n    } else {\n      //ping++ 支付渠道 pc网页\n      //根据不同的客户端调用不同的支付方式\n      let map;\n      if (checkMobile(this.userAgent())) {\n        map={\n          type:2,\n          status:1\n        }\n        if(!is_weixin(this.userAgent())){\n          map.channel =[\"!=\",\"wx_pub\"]\n        }\n\n      }else {\n        map={\n          type:1,\n          status:1\n        }\n\n      }\n      let paylist = await this.model(\"pingxx\").where(map).order(\"sort ASC\").select();\n      this.assign(\"paylist\", paylist);\n      this.meta_title = \"充值\";\n      if (checkMobile(this.userAgent())) {\n        this.active = \"user/index\";\n        return this.display(`mobile/${this.http.controller}/${this.http.action}`)\n      } else {\n\n        this.display();\n      }\n\n    }\n\n  }\n}"
    ]
}
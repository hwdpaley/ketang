{
    "version": 3,
    "sources": [
        "../../../src/admin/controller/ueditor.js"
    ],
    "names": [
        "__before",
        "model",
        "getset",
        "setup",
        "islogin",
        "is_login",
        "fail",
        "session",
        "user",
        "res",
        "think",
        "isEmpty",
        "uid",
        "init",
        "http",
        "indexAction",
        "config",
        "action",
        "get",
        "result",
        "uploads",
        "uploadlist",
        "crawler",
        "state",
        "jsonp",
        "base64",
        "fieldName",
        "pathFormat",
        "maxSize",
        "allowFiles",
        "IS_QINIU",
        "file",
        "extend",
        "filepath",
        "path",
        "basename",
        "qiniu",
        "service",
        "instance",
        "uploadpic",
        "uppic",
        "QINIU_DOMAIN_NAME",
        "key",
        "hash",
        "originalFilename",
        "up",
        "adapter",
        "upload",
        "getFileInfo",
        "source",
        "post",
        "isArray",
        "list",
        "imgUrl",
        "saveRemote",
        "info",
        "push",
        "url",
        "title",
        "original",
        "listSize",
        "size",
        "start",
        "end",
        "parseInt",
        "substr",
        "lastIndexOf",
        "files",
        "scanFolder",
        "length",
        "len",
        "files_n",
        "i",
        "t",
        "toLocaleLowerCase",
        "in_array",
        "lenn",
        "Math",
        "min",
        "f",
        "fileList",
        "folderList",
        "walk",
        "readdirSync",
        "RESOURCE_PATH",
        "forEach",
        "item",
        "tmpPath",
        "stats",
        "statSync",
        "isDirectory",
        "console",
        "log",
        "controller",
        "base"
    ],
    "mappings": "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",
    "file": "../../../src/admin/controller/ueditor.js",
    "sourcesContent": [
        "// +----------------------------------------------------------------------\n// | Bieber [ 美媒网站内容管理框架 ]\n// +----------------------------------------------------------------------\n// | Copyright (c) 2017 http://www.gzxinbibo.com All rights reserved.\n// +----------------------------------------------------------------------\n// | Author: Tony <912697590@qq.com>\n// +----------------------------------------------------------------------\n'use strict';\n\n//import Base from './base.js';\nimport fs from 'fs';\nimport path from 'path';\nexport default class extends think.controller.base {\n    async __before() {\n        //网站配置\n        this.setup = await this.model(\"setup\").getset();\n        //登陆验证\n        let is_login = await this.islogin();\n        if (!is_login) {\n            return this.fail(\"非法操作!\");\n        }\n    }\n    /**\n     * 判断是否登录\n     * @returns {boolean}\n     */\n    async islogin() {\n        //判断是否登录\n        let user = await this.session('userInfo');\n        let res = think.isEmpty(user) ? false : user.uid;\n        return res;\n\n    }\n  init(http) {\n    super.init(http);\n  }\n  /**\n   * index action\n   * @return {Promise} []\n   */\n  async indexAction(){\n    //auto render template file index_index.html\n    this.config = this.config(\"ueditor\");\n    let action = this.get(\"action\");\n    //think.log(action);\n    let result;\n    switch (action) {\n      case 'config':\n        result = this.config;\n\n        break;\n\n        /* 上传图片 */\n      case 'uploadimage':\n        /* 上传涂鸦 */\n      case 'uploadscrawl':\n        /* 上传视频 */\n      case 'uploadvideo':\n        /* 上传文件 */\n      case 'uploadfile':\n\n        result =await this.uploads();\n        //console.log(result);\n        break;\n\n        /* 列出图片 */\n      case 'listimage':\n        result = this.uploadlist();\n        break;\n        /* 列出文件 */\n      case 'listfile':\n        result = this.uploadlist();\n        break;\n\n        /* 抓取远程文件 */\n      case 'catchimage':\n        result = await this.crawler();\n        break;\n\n      default:\n        result = {\n          state: '请求地址出错'\n        };\n\n        break;\n    }\n    //返回结果\n    this.jsonp(result);\n\n  }\n\n  async uploads(){\n    /**\n     * 得到上传文件所对应的各个参数,数组结构\n     * obj={\n     *     \"state\" : \"\",          //上传状态，上传成功时必须返回\"SUCCESS\"\n     *     \"url\" : \"\",            //返回的地址\n     *     \"title\" : \"\",          //新文件名\n     *     \"original\" : \"\",       //原始文件名\n     *     \"type\" : \"\" ,           //文件类型\n     *     \"size\" : \"\",           //文件大小\n     * }\n     */\n    let action = this.get(\"action\");\n    let base64 = \"upload\";\n    let config = {};\n    let fieldName;\n    //console.log(setup);\n    switch (action) {\n      case 'uploadimage':\n        config = {\n          pathFormat: this.config['imagePathFormat'],\n          maxSize: this.config['imageMaxSize'],\n          allowFiles: this.config['imageAllowFiles'],\n        };\n        fieldName = this.config['imageFieldName'];\n        break;\n      case 'uploadscrawl':\n        config = {\n          \"pathFormat\": this.config['scrawlPathFormat'],\n          \"maxSize\": this.config['scrawlMaxSize'],\n          \"allowFiles\": this.config['scrawlAllowFiles'],\n          \"oriName\": \"scrawl.png\"\n        };\n        fieldName = this.config['scrawlFieldName'];\n        base64 = \"base64\";\n        break;\n      case 'uploadvideo':\n        config = {\n          \"pathFormat\": this.config['videoPathFormat'],\n          \"maxSize\": this.config['videoMaxSize'],\n          \"allowFiles\": this.config['videoAllowFiles']\n        };\n        fieldName = this.config['videoFieldName'];\n        break;\n      case 'uploadfile':\n      default:\n        config = {\n          \"pathFormat\": this.config['filePathFormat'],\n          \"maxSize\": this.config['fileMaxSize'],\n          \"allowFiles\": this.config['fileAllowFiles']\n        };\n        fieldName = this.config['fileFieldName'];\n        break;\n    }\n     //加入七牛接口\n     if(this.setup.IS_QINIU==1 && base64==\"upload\"){\n       let file = think.extend({}, this.file(fieldName));\n       // console.log(file);\n       let filepath = file.path;\n       let basename = path.basename(filepath);\n       let qiniu = think.service(\"qiniu\");\n       let instance = new qiniu();\n       let uppic = await instance.uploadpic(filepath,basename);\n       if(!think.isEmpty(uppic)){\n         return {\n           \"state\" : \"SUCCESS\",\n           \"url\" : `//${this.setup.QINIU_DOMAIN_NAME}/${uppic.key}`,\n           \"title\" : uppic.hash,\n           \"original\" : file.originalFilename,\n           \"type\" : \".jpg\",\n           \"size\" : 0\n         };\n       }\n     } else {\n       //return self.uploader(fieldName, config, oriName, size, path, base64);\n       let up = think.adapter(\"editor\", \"ueditor\"); //加载名为 ueditor 的 editor Adapter\n       let upload = new up(fieldName, config, base64, this.http); //实例化 Adapter\n       return upload.getFileInfo();\n     }\n  }\n\n  //抓取远程图片\n  async crawler(){\n    /* 上传配置 */\n    let config = {\n      \"pathFormat\" : this.config['catcherPathFormat'],\n      \"maxSize\" : this.config['catcherMaxSize'],\n      \"allowFiles\" : this.config['catcherAllowFiles'],\n      \"oriName\" : \"remote.png\"\n    };\n    let fieldName = this.config['catcherFieldName'];\n    let source = this.post(fieldName+\"[]\");\n    if(think.isArray(source)) {\n      source = source;\n    }else{\n      source = [source];\n    }\n    let list = [];\n    for(let imgUrl of source){\n      let up = think.adapter(\"editor\", \"ueditor\"); //加载名为 ueditor 的 editor Adapter\n      let upload = new up(imgUrl, config, \"remote\"); //实例化 Adapter\n      let info =  await upload.saveRemote();\n      //console.log(info);\n      list.push({\"state\":\"SUCCESS\",\"url\":info.url,\"size\":431521,\"title\":info.title,\"original\":info.original,\"source\":imgUrl});\n    }\n    //console.log(think.isEmpty(list));\n    return {\n      state:!think.isEmpty(list) ? 'SUCCESS':'ERROR',\n      list:list\n    }\n  }\n\n  /**\n   * 获取已上传的文件列表\n   */\n  uploadlist() {\n    var allowFiles, listSize, path;\n    //判断类型\n    switch (this.get(\"action\")) {\n        //列出文件\n      case 'listfile':\n        allowFiles = this.config['fileManagerAllowFiles'];\n        listSize = this.config['fileManagerListSize'];\n        path = this.config['fileManagerListPath'];\n        break;\n        //列出图片\n      case 'listimage':\n      default:\n        allowFiles = this.config['imageManagerAllowFiles'];\n        listSize = this.config['imageManagerListSize'];\n        path = this.config['imageManagerListPath'];\n    }\n    //allowFiles = allowFiles.join(\"\").replace(/[.]/g,\"|\").substr(1);\n    /* 获取参数 */\n    var size = this.get('size') ? this.get('size') : listSize;\n    var start = this.get('start') ? this.get('start') : 0;\n    var end = parseInt(size) + parseInt(start);\n    /* 获取文件列表 */\n    path = path.substr(0, path.lastIndexOf(\"/\"));\n    var files = this.scanFolder(path).files;\n    if (files.length == 0) {\n      return {\n        \"state\": \"no match file\",\n        \"list\": [],\n        \"start\": start,\n        \"total\": files.length\n      }\n    }\n    /* 获取指定范围的列表 */\n    var len = files.length;\n    var files_n=[];\n    for(var i = 0; i<len ; i++){\n      var t= files[i].substr(files[i].lastIndexOf(\".\")).toLocaleLowerCase();\n      if(in_array(t,allowFiles)){\n        files_n.push(files[i])\n      }\n    }\n\n    var lenn=files_n.length;\n    for (var i = Math.min(end, lenn) - 1,list=[]; i < lenn && i >= 0 && i >= start; i--) {\n      var f=files_n[i];\n      list.push({url:f});\n    }\n\n    return {\n      \"state\": \"SUCCESS\",\n      \"list\": list,\n      \"start\": start,\n      \"total\": files.length\n    };\n\n  }\n  /**\n   * 遍历获取目录下的指定类型的文件\n   */\n  scanFolder(path) {\n    var fileList = [],\n        folderList = [],\n        walk = function (path, fileList, folderList) {\n          let files = fs.readdirSync(think.RESOURCE_PATH+\"/\"+path);\n          files.forEach(function (item) {\n            var tmpPath = path + '/' + item,\n                stats = fs.statSync(think.RESOURCE_PATH+\"/\"+tmpPath);\n\n            if (stats.isDirectory()) {\n              walk(tmpPath, fileList, folderList);\n              folderList.push(tmpPath);\n            } else {\n              fileList.push(tmpPath);\n            }\n          });\n        };\n\n    walk(path, fileList, folderList);\n\n    console.log('扫描' + path + '成功');\n\n    return {\n      'files': fileList,\n      'folders': folderList\n    }\n  }\n}\n"
    ]
}